<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facturaci√≥n - La Parada del Ma√≠z</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* === DISE√ëO MODERNO === */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff7ed 100%);
      min-height: 100vh;
    }

    .banner {
      border-radius: 0 0 60px 60px;
      box-shadow: 0 15px 50px rgba(245, 158, 11, 0.3);
    }

    .nav-btn {
      border-radius: 16px;
      padding: 10px 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .nav-yellow {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .nav-yellow:hover {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .nav-green {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
    }

    .nav-green:hover {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .input-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .input-modern:focus {
      border-color: #f59e0b;
      background: white;
      box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.15);
      outline: none;
    }

    .select-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .select-modern:focus {
      border-color: #f59e0b;
      background: white;
      box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.15);
      outline: none;
    }

    .btn-primary {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.45);
    }

    .btn-success {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }

    .btn-success:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.45);
    }

    .btn-danger {
      border-radius: 12px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }

    .item-card {
      background: linear-gradient(135deg, #ffffff, #fefbf4);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(245, 158, 11, 0.1);
      transition: all 0.3s ease;
    }

    .item-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(245, 158, 11, 0.15);
    }

    .badge-usuario {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      padding: 10px 20px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
    }

    .badge-stock {
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .badge-stock-alto {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }

    .badge-stock-medio {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }

    .badge-stock-bajo {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    .badge-total {
      background: linear-gradient(135deg, #34d399, #10b981);
      padding: 12px 24px;
      border-radius: 16px;
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    .modal-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(30px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
    }

    .modal-btn {
      border-radius: 14px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .modal-btn-cancel {
      background: linear-gradient(135deg, #e5e7eb, #d1d5db);
      color: #374151;
    }

    .modal-btn-save {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
    }

    .info-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .section-title {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (max-width: 640px) {
      .glass-card {
        padding: 20px;
        border-radius: 22px;
      }
      
      .banner {
        border-radius: 0 0 45px 45px;
      }
    }
  </style>
</head>
<body>

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/50 to-yellow-600/60 flex items-center justify-center banner">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center px-4 drop-shadow-lg">
        üßæ Facturaci√≥n
      </h1>
    </div>
  </div>

  <!-- Navegaci√≥n -->
  <nav class="flex flex-wrap justify-center gap-3 mt-6 px-4">
    <a href="index.html" class="nav-btn nav-yellow text-sm">üì¶ Art√≠culos</a>
    <a href="historial.html" class="nav-btn nav-yellow text-sm">üìã Historial</a>
  </nav>

  <!-- Crear Factura -->
  <section class="max-w-4xl mx-auto mt-6 mx-4 mb-10">
    <div class="glass-card">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üßæ Crear Factura</h2>
      
      <!-- Usuario logeado -->
      <div class="flex justify-center mb-6">
        <div class="badge-usuario">
          üë§ <span id="nombreUsuario">Cargando...</span>
        </div>
      </div>

      <!-- Selector de art√≠culo -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Art√≠culo:</label>
        <select id="articuloSelect" onchange="mostrarStockDisponible()" class="select-modern w-full">
          <option value="">Selecciona un art√≠culo</option>
        </select>
        <p id="stockInfo" class="text-sm text-gray-500 mt-2 hidden">
          <span class="font-medium">Disponible:</span> 
          <span id="stockDisponible" class="font-bold">0</span> unidades
        </p>
      </div>

      <!-- Cantidad y fecha -->
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <div class="w-full sm:w-1/2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad:</label>
          <input type="number" id="cantidad" placeholder="Cantidad" min="1" max="1000"
                 class="input-modern w-full">
        </div>
        <div class="w-full sm:w-1/2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
          <input type="date" id="fechaFactura" class="input-modern w-full">
        </div>
      </div>

      <!-- Bot√≥n agregar -->
      <button onclick="agregarItem()" class="btn-primary w-full mb-6">
        ‚ûï Agregar a Factura
      </button>

      <!-- Detalle de factura -->
      <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Detalle de Factura</h3>
      <div id="detalleLista" class="space-y-4 mb-6"></div>

      <!-- Descuento -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
        <label class="font-medium text-gray-700">Descuento (RD$):</label>
        <input type="number" id="descuento" value="0" min="0" step="0.01" oninput="actualizarVistaFactura()"
               class="input-modern w-full sm:w-32">
      </div>

      <!-- Comentario -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Comentario (opcional):</label>
        <input type="text" id="comentario" placeholder="Agregar un comentario..."
               class="input-modern w-full">
      </div>

      <!-- Total -->
      <div class="flex justify-center mb-6">
        <div class="text-center">
          <p class="text-gray-600 font-medium mb-2">Total de la Factura</p>
          <div class="badge-total">
            RD$ <span id="totalFactura">0.00</span>
          </div>
        </div>
      </div>

      <!-- Bot√≥n guardar -->
      <button onclick="mostrarModalGuardar()" id="guardarBtn" class="btn-success w-full">
        üíæ Guardar Factura
      </button>
      <div id="loading" class="hidden mt-2 text-green-600 text-center font-medium">Guardando...</div>
    </div>
  </section>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4">
    <div class="modal-content w-full max-w-sm">
      <h3 class="text-xl font-bold text-gray-800 mb-4">üíæ Confirmar Guardado</h3>
      <p class="text-gray-600 mb-6">¬øEst√°s seguro de que deseas guardar esta factura? Se descontar√° del inventario.</p>
      <div class="flex justify-end gap-3">
        <button onclick="cerrarModal()" class="modal-btn modal-btn-cancel">Cancelar</button>
        <button onclick="confirmarGuardar()" class="modal-btn modal-btn-save">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let itemsFactura = [];
    let articulosData = [];
    let usuarioActual = null;

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : tipo === 'warning' ? "#ffc107" : "#28a745"
      }).showToast();
    }

    function obtenerFechaHoyLocal() {
      const hoy = new Date();
      return `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
    }

    function verificarUsuario() {
      const usuario = localStorage.getItem('usuario');
      if (!usuario) {
        window.location.href = 'login.html';
        return null;
      }
      usuarioActual = JSON.parse(usuario);
      document.getElementById('nombreUsuario').textContent = usuarioActual.username;
      return usuarioActual;
    }

    async function cargarArticulos() {
      try {
        const { data, error } = await supabaseClient.from('articulos').select('*');
        if (error) throw error;
        articulosData = data;
        const select = document.getElementById('articuloSelect');
        select.innerHTML = '<option value="">Selecciona un art√≠culo</option>';
        data.forEach(articulo => {
          const option = document.createElement('option');
          option.value = articulo.id;
          const stock = articulo.stock || 0;
          option.textContent = `${articulo.nombre} - RD$${parseFloat(articulo.precio).toFixed(2)} (${stock} disp.)`;
          option.dataset.precio = articulo.precio;
          option.dataset.stock = stock;
          option.dataset.nombre = articulo.nombre;
          if (stock <= 0) {
            option.style.color = '#dc3545';
            option.textContent += ' - AGOTADO';
          }
          select.appendChild(option);
        });
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      }
    }

    function mostrarStockDisponible() {
      const select = document.getElementById('articuloSelect');
      const stockInfo = document.getElementById('stockInfo');
      const stockDisponible = document.getElementById('stockDisponible');
      
      if (select.value) {
        const stock = parseInt(select.options[select.selectedIndex].dataset.stock);
        const enFactura = itemsFactura.find(item => item.articulo_id == select.value);
        const cantidadEnFactura = enFactura ? enFactura.cantidad : 0;
                const disponibleReal = stock - cantidadEnFactura;
        stockDisponible.textContent = disponibleReal;
        stockInfo.classList.remove('hidden');
        
        // Actualizar color seg√∫n disponibilidad
        const badge = document.getElementById('stockInfo');
        if (disponibleReal <= 0) {
          badge.className = 'text-sm mt-2 badge-stock badge-stock-bajo';
        } else if (disponibleReal <= 10) {
          badge.className = 'text-sm mt-2 badge-stock badge-stock-medio';
        } else {
          badge.className = 'text-sm mt-2 badge-stock badge-stock-alto';
        }
      } else {
        stockInfo.classList.add('hidden');
      }
    }

    function agregarItem() {
      const select = document.getElementById('articuloSelect');
      const cantidad = parseInt(document.getElementById('cantidad').value);
      
      if (!select.value) {
        return mostrarNotificacion("Selecciona un art√≠culo.", 'warning');
      }
      if (!cantidad || cantidad <= 0) {
        return mostrarNotificacion("Cantidad inv√°lida.", 'warning');
      }

      const articuloId = select.value;
      const nombre = select.options[select.selectedIndex].dataset.nombre;
      const precio = parseFloat(select.options[select.selectedIndex].dataset.precio);
      const stockDisponible = parseInt(select.options[select.selectedIndex].dataset.stock);

      const existe = itemsFactura.find(item => item.articulo_id == articuloId);
      const cantidadYaEnFactura = existe ? existe.cantidad : 0;
      
      if (cantidad + cantidadYaEnFactura > stockDisponible) {
        return mostrarNotificacion(`Stock insuficiente. Solo hay ${stockDisponible - cantidadYaEnFactura}.`, 'error');
      }

      if (existe) {
        existe.cantidad += cantidad;
        existe.subtotal = existe.precio * existe.cantidad;
      } else {
        itemsFactura.push({
          articulo_id: articuloId,
          nombre,
          cantidad,
          precio,
          subtotal: precio * cantidad
        });
      }

      actualizarVistaFactura();
      document.getElementById('cantidad').value = "";
      mostrarStockDisponible();
    }

    function actualizarVistaFactura() {
      const lista = document.getElementById('detalleLista');
      lista.innerHTML = "";
      let subtotalGeneral = 0;
      
      if (itemsFactura.length === 0) {
        lista.innerHTML = '<p class="text-center text-gray-500 py-4">No hay art√≠culos en la factura</p>';
      }
      
      itemsFactura.forEach((item, index) => {
        subtotalGeneral += item.subtotal;
        
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800">${item.nombre}</h4>
              <p class="text-sm text-gray-500">
                Cantidad: <span class="font-medium">${item.cantidad}</span> | 
                Precio: <span class="font-medium">RD$${item.precio.toFixed(2)}</span>
              </p>
            </div>
            <div class="flex items-center gap-3">
              <span class="badge-total text-base">RD$${item.subtotal.toFixed(2)}</span>
              <button onclick="eliminarItem(${index})" class="btn-danger">üóëÔ∏è</button>
            </div>
          </div>
        `;
        lista.appendChild(card);
      });
      
      const descuento = parseFloat(document.getElementById('descuento').value) || 0;
      document.getElementById('totalFactura').textContent = (subtotalGeneral - descuento).toFixed(2);
    }

    function eliminarItem(index) {
      itemsFactura.splice(index, 1);
      actualizarVistaFactura();
      mostrarStockDisponible();
    }

    function mostrarModalGuardar() {
      if (itemsFactura.length === 0) {
        return mostrarNotificacion("Agrega al menos un art√≠culo", 'warning');
      }
      document.getElementById('confirmModal').classList.remove('hidden');
      document.getElementById('confirmModal').classList.add('flex');
    }

    function cerrarModal() {
      document.getElementById('confirmModal').classList.add('hidden');
      document.getElementById('confirmModal').classList.remove('flex');
    }

    async function confirmarGuardar() {
      cerrarModal();
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('loading').textContent = 'Guardando...';
      
      try {
        let subtotal = 0;
        itemsFactura.forEach(item => subtotal += item.subtotal);
        
        const descuento = parseFloat(document.getElementById('descuento').value) || 0;
        const total = subtotal - descuento;
        const comentario = document.getElementById('comentario').value.trim();
        const fechaInput = document.getElementById('fechaFactura').value;
        
        if (!fechaInput) {
          throw new Error("Selecciona una fecha");
        }

        // GUARDAR FACTURA CON USUARIO
        const { data: facturaData, error: facturaError } = await supabaseClient
          .from('facturas')
          .insert([{
            fecha: fechaInput + 'T12:00:00',
            subtotal,
            descuento,
            total,
            comentario,
            usuario: usuarioActual.username
          }])
          .select();
        
        if (facturaError) throw facturaError;

        const facturaId = facturaData[0].id;
        const detalles = itemsFactura.map(item => ({
          factura_id: facturaId,
          articulo_id: item.articulo_id,
          cantidad: item.cantidad,
          precio: item.precio,
          subtotal: item.subtotal
        }));
        
        await supabaseClient.from('detalle_factura').insert(detalles);

        // Actualizar stock
        for (const item of itemsFactura) {
          const articulo = articulosData.find(a => a.id == item.articulo_id);
          if (articulo) {
            await supabaseClient
              .from('articulos')
              .update({ stock: Math.max(0, (articulo.stock || 0) - item.cantidad) })
              .eq('id', item.articulo_id);
          }
        }

        mostrarNotificacion("‚úÖ Factura guardada correctamente");
        
        // Limpiar formulario
        itemsFactura = [];
        actualizarVistaFactura();
        document.getElementById('descuento').value = "0";
        document.getElementById('comentario').value = "";
        document.getElementById('stockInfo').classList.add('hidden');
        
        await cargarArticulos();
        
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      }
      finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Actualizar conexi√≥n cada 30 segundos
    setInterval(async () => {
      const usuario = localStorage.getItem('usuario');
      if (usuario) {
        const usuarioObj = JSON.parse(usuario);
        try {
          await supabaseClient
            .from('usuarios')
            .update({ ultima_conexion: new Date().toISOString() })
            .eq('username', usuarioObj.username);
        } catch (e) {
          console.error('Error actualizando conexi√≥n:', e);
        }
      }
    }, 30000);

    window.onload = () => {
      verificarUsuario();
      cargarArticulos();
      document.getElementById('fechaFactura').value = obtenerFechaHoyLocal();
    };
  </script>
</body>
</html>
