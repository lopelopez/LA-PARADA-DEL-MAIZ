<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Art√≠culos Defectuosos - La Parada del Ma√≠z</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* === DISE√ëO MODERNO === */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff7ed 100%);
      min-height: 100vh;
    }

    .banner {
      border-radius: 0 0 60px 60px;
      box-shadow: 0 15px 50px rgba(245, 158, 11, 0.3);
    }

    .nav-btn {
      border-radius: 16px;
      padding: 10px 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .nav-yellow {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .nav-yellow:hover {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .input-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .input-modern:focus {
      border-color: #ef4444;
      background: white;
      box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.15);
      outline: none;
    }

    .select-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .select-modern:focus {
      border-color: #ef4444;
      background: white;
      box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.15);
      outline: none;
    }

    .btn-danger {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
    }

    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.45);
    }

    .card-defectuoso {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      transition: all 0.3s ease;
    }

    .card-defectuoso:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(239, 68, 68, 0.2);
    }

    .badge-info {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      padding: 10px 20px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
    }

    .badge-cantidad {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      padding: 8px 16px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      color: #991b1b;
    }

    .badge-fecha {
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #4338ca;
    }

    .section-title {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .info-box {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #ef4444;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
      .glass-card {
        padding: 20px;
        border-radius: 22px;
      }
      
      .banner {
        border-radius: 0 0 45px 45px;
      }
    }
  </style>
</head>
<body>

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-b from-red-500/50 to-red-600/60 flex items-center justify-center banner">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center px-4 drop-shadow-lg">
        ‚ö†Ô∏è Art√≠culos Defectuosos
      </h1>
    </div>
  </div>

  <!-- Navegaci√≥n -->
  <nav class="flex flex-wrap justify-center gap-3 mt-6 px-4">
    <a href="index.html" class="nav-btn nav-yellow text-sm">üì¶ Art√≠culos</a>
  </nav>

  <!-- Art√≠culos Defectuosos -->
  <section class="max-w-4xl mx-auto mt-6 mx-4 mb-10">
    <div class="glass-card">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">‚ö†Ô∏è Registrar Art√≠culo Defectuoso</h2>

      <!-- Loading -->
      <div id="loading" class="flex justify-center py-8">
        <div class="loading-spinner"></div>
      </div>

      <!-- Formulario -->
      <div id="formulario" class="hidden">
        <!-- Selector de art√≠culo -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Art√≠culo:</label>
          <select id="articuloSelect" class="select-modern w-full">
            <option value="">Selecciona un art√≠culo</option>
          </select>
        </div>

        <!-- Cantidad y descripci√≥n -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
          <div class="w-full sm:w-1/2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad Defectuosa:</label>
            <input type="number" id="cantidad" placeholder="Cantidad" min="1" 
                   class="input-modern w-full">
          </div>
          <div class="w-full sm:w-1/2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n del Defecto:</label>
            <input type="text" id="descripcion" placeholder="Describe el defecto..." 
                   class="input-modern w-full">
          </div>
        </div>

        <!-- Bot√≥n registrar -->
        <button onclick="registrarDefectuoso()" class="btn-danger w-full">
          ‚ö†Ô∏è Registrar Defecto
        </button>

        <!-- Historial -->
        <h3 class="text-2xl font-bold section-title mt-8 mb-4 text-center">üìã Historial de Defectuosos</h3>
        <div id="listaDefectuosos" class="space-y-4"></div>
        <div id="noData" class="info-box text-center hidden">
          <p class="text-red-700">üì≠ No hay art√≠culos defectuosos registrados</p>
        </div>
      </div>
    </div>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function formatearFecha(fechaStr) {
      if (!fechaStr) return '--/--/----';
      const fecha = new Date(fechaStr);
      return `${String(fecha.getDate()).padStart(2, '0')}/${String(fecha.getMonth() + 1).padStart(2, '0')}/${fecha.getFullYear()}`;
    }

    async function cargarArticulos() {
      try {
        const { data } = await supabaseClient.from('articulos').select('id, nombre, stock');
        const select = document.getElementById('articuloSelect');
        select.innerHTML = '<option value="">Selecciona un art√≠culo</option>';
        
        data.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = `${a.nombre} (Stock: ${a.stock})`;
          select.appendChild(opt);
        });
      } catch (e) {
        mostrarNotificacion('Error cargando art√≠culos: ' + e.message, 'error');
      }
    }

    async function registrarDefectuoso() {
      const articuloId = document.getElementById('articuloSelect').value;
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const descripcion = document.getElementById('descripcion').value.trim();

      if (!articuloId) {
        return mostrarNotificacion('Seleccione un art√≠culo', 'warning');
      }
      if (!cantidad || cantidad <= 0) {
        return mostrarNotificacion('Ingrese una cantidad v√°lida', 'warning');
      }
      if (!descripcion) {
        return mostrarNotificacion('Ingrese la descripci√≥n del defecto', 'warning');
      }

      try {
        // 1. Registrar defectuoso
        await supabaseClient.from('articulos_defectuosos').insert([{
          articulo_id: articuloId,
          cantidad,
          descripcion,
          fecha: new Date().toISOString()
        }]);

        // 2. Descontar del stock
        const { data: articulo } = await supabaseClient
          .from('articulos')
          .select('stock')
          .eq('id', articuloId)
          .single();
        
        const nuevoStock = (articulo.stock || 0) - cantidad;
        
        await supabaseClient
          .from('articulos')
          .update({ stock: Math.max(0, nuevoStock) })
          .eq('id', articuloId);

        mostrarNotificacion('‚úÖ Art√≠culo defectuoso registrado y stock actualizado');
        
        // Limpiar formulario
        document.getElementById('cantidad').value = '';
        document.getElementById('descripcion').value = '';
        document.getElementById('articuloSelect').value = '';
        
        await cargarArticulos();
        await cargarHistorial();
        
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    async function cargarHistorial() {
      try {
        const { data } = await supabaseClient
          .from('articulos_defectuosos')
          .select('*, articulos(nombre)')
          .order('fecha', { ascending: false });

        const lista = document.getElementById('listaDefectuosos');
        const noData = document.getElementById('noData');
        lista.innerHTML = '';

        if (!data || data.length === 0) {
          noData.classList.remove('hidden');
          return;
        }
        
        noData.classList.add('hidden');

        data.forEach(d => {
          const card = document.createElement('div');
          card.className = 'card-defectuoso';
          card.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h4 class="font-bold text-gray-800 text-lg">${d.articulos.nombre}</h4>
                  <span class="badge-cantidad">${d.cantidad} uds</span>
                </div>
                <p class="text-gray-600">${d.descripcion}</p>
              </div>
              <div class="flex flex-col items-end gap-2">
                <span class="badge-fecha">üìÖ ${formatearFecha(d.fecha)}</span>
              </div>
            </div>
          `;
          lista.appendChild(card);
        });
        
      } catch (e) {
        mostrarNotificacion('Error cargando historial: ' + e.message, 'error');
      }
    }

    // Actualizar conexi√≥n cada 30 segundos
    setInterval(async () => {
      const usuario = localStorage.getItem('usuario');
      if (usuario) {
        const usuarioObj = JSON.parse(usuario);
        try {
          await supabaseClient
            .from('usuarios')
            .update({ ultima_conexion: new Date().toISOString() })
            .eq('username', usuarioObj.username);
        } catch (e) {
          console.error('Error actualizando conexi√≥n:', e);
        }
      }
    }, 30000);

    window.onload = async () => {
      await cargarArticulos();
      await cargarHistorial();
      
      // Ocultar loading y mostrar formulario
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('formulario').classList.remove('hidden');
    };
  </script>
</body>
</html>
