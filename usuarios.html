<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Usuarios - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center">Gestión de Usuarios</h1>
    </div>
  </div>

  <nav class="flex flex-wrap justify-center gap-2 mt-4 px-2">
    <a href="index.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Artículos</a>
    <a href="facturacion.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Facturación</a>
    <a href="historial.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Historial</a>
    <a href="cajachica.html" class="bg-red-400 text-white px-4 py-2 rounded shadow text-sm">Caja Chica</a>
    <button onclick="cerrarSesion()" class="bg-gray-400 text-white px-4 py-2 rounded shadow text-sm">Cerrar Sesión</button>
  </nav>

  <section class="max-w-4xl mx-auto mt-6 bg-white p-4 rounded-xl shadow mx-2">
    <h2 class="text-2xl font-semibold mb-4 text-center">Usuarios Registrados</h2>
    
    <div id="loading" class="hidden text-center text-yellow-600 mb-4">Cargando...</div>
    <ul id="listaUsuarios" class="space-y-2"></ul>
    <div id="noData" class="text-center text-gray-500 mt-4 hidden">No hay usuarios</div>
  </section>

  <!-- Modal Bloquear/Desbloquear -->
  <div id="modalBloqueo" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white p-4 rounded-lg w-full max-w-sm">
      <h3 class="font-semibold mb-4" id="tituloBloqueo">Bloquear Usuario</h3>
      <p class="text-sm text-gray-600 mb-4" id="mensajeBloqueo">¿Estás seguro?</p>
      <input type="password" id="passwordAdmin" class="border p-2 rounded w-full mb-4" placeholder="Tu contraseña">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalBloqueo()" class="bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
        <button onclick="confirmarBloqueo()" class="bg-red-400 text-white px-3 py-2 rounded">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let usuarioSeleccionado = null;
    let accionBloqueo = '';

    function msg(txt, tipo = 'success') {
      Toastify({ text: txt, duration: 3000, backgroundColor: tipo === 'error' ? '#dc3545' : '#28a745' }).showToast();
    }

    function obtenerFechaHoy() {
      const h = new Date();
      return `${h.getFullYear()}-${String(h.getMonth() + 1).padStart(2, '0')}-${String(h.getDate()).padStart(2, '0')}`;
    }

    function obtenerHora(fechaStr) {
      if (!fechaStr) return '--:--';
      const fecha = new Date(fechaStr);
      return fecha.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
    }

    function obtenerFecha(fechaStr) {
      if (!fechaStr) return '--/--/----';
      const fecha = new Date(fechaStr);
      return `${String(fecha.getDate()).padStart(2, '0')}/${String(fecha.getMonth() + 1).padStart(2, '0')}/${fecha.getFullYear()}`;
    }

    function verificarAdmin() {
      const usuario = localStorage.getItem('usuario');
      if (!usuario) {
        window.location.href = 'login.html';
        return null;
      }
      const usuarioObj = JSON.parse(usuario);
      if (usuarioObj.username !== 'leidylop') {
        msg('Solo leidylop puede acceder', 'error');
        window.location.href = 'index.html';
        return null;
      }
      return usuarioObj;
    }

    async function cargarUsuarios() {
      document.getElementById('loading').classList.remove('hidden');
      
      try {
        const { data, error } = await supabaseClient
          .from('usuarios')
          .select('id, username, bloqueado, ultima_conexion, hora_inicio_sesion')
          .order('username', { ascending: true });

        if (error) throw error;

        const lista = document.getElementById('listaUsuarios');
        const noData = document.getElementById('noData');
        lista.innerHTML = '';

        if (!data || data.length === 0) {
          noData.classList.remove('hidden');
          return;
        }
        noData.classList.add('hidden');

        const hoy = obtenerFechaHoy();
        const ahora = new Date();

        data.forEach(u => {
          let estado = '';
          let estadoColor = '';
          let infoHora = '';
          
          if (u.bloqueado) {
            estado = 'Bloqueado';
            estadoColor = 'bg-red-100 text-red-600';
          } else if (!u.ultima_conexion) {
            estado = 'Sin iniciar sesión';
            estadoColor = 'bg-gray-100 text-gray-600';
          } else {
            let ultimaFecha = u.ultima_conexion;
            try {
              ultimaFecha = u.ultima_conexion.split('T')[0];
            } catch (e) {}
            
            const ultimaHora = new Date(u.ultima_conexion);
            const diferenciaMinutos = (ahora - ultimaHora) / 1000 / 60;
            
            if (ultimaFecha === hoy && diferenciaMinutos < 5) {
              estado = 'Conectado';
              estadoColor = 'bg-green-100 text-green-600';
              if (u.hora_inicio_sesion) {
                infoHora = `<div class="text-xs text-green-600 mt-1">Inició: ${obtenerHora(u.hora_inicio_sesion)}</div>`;
              } else {
                infoHora = `<div class="text-xs text-green-600 mt-1">Ahora</div>`;
              }
            } else if (ultimaFecha === hoy && diferenciaMinutos < 60) {
              estado = 'Desconectado';
              estadoColor = 'bg-yellow-100 text-yellow-600';
              infoHora = `<div class="text-xs text-gray-500 mt-1">Hace ${Math.floor(diferenciaMinutos)} min</div>`;
            } else if (ultimaFecha === hoy) {
              estado = 'Desconectado';
              estadoColor = 'bg-yellow-100 text-yellow-600';
              infoHora = `<div class="text-xs text-gray-500 mt-1">Última: ${obtenerHora(u.ultima_conexion)}</div>`;
            } else {
              estado = 'Desconectado';
              estadoColor = 'bg-yellow-100 text-yellow-600';
              infoHora = `<div class="text-xs text-gray-500 mt-1">Última: ${obtenerFecha(u.ultima_conexion)} ${obtenerHora(u.ultima_conexion)}</div>`;
            }
          }

          const li = document.createElement('li');
          li.className = "bg-yellow-100 p-3 rounded-lg flex justify-between items-center";
          
          const esAdmin = u.username === 'leidylop';
          const opciones = esAdmin ? 
            '<span class="text-xs text-purple-600 font-medium">Administrador</span>' :
            `<div class="flex gap-2">
              <button onclick="solicitarBloqueo('${u.username}', ${u.bloqueado})" class="px-2 py-1 text-xs rounded ${u.bloqueado ? 'bg-green-400 text-white' : 'bg-red-400 text-white'}">
                ${u.bloqueado ? 'Desbloquear' : 'Bloquear'}
              </button>
              <button onclick="eliminarUsuario('${u.username}')" class="px-2 py-1 text-xs bg-gray-400 text-white rounded">
                Eliminar
              </button>
            </div>`;

          li.innerHTML = `
            <div>
              <span class="font-semibold">${u.username}</span>
              <span class="ml-2 px-2 py-1 text-xs rounded ${estadoColor}">${estado}</span>
              ${infoHora}
            </div>
            ${opciones}
          `;
          lista.appendChild(li);
        });

      } catch (error) {
        msg('Error: ' + error.message, 'error');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    setInterval(cargarUsuarios, 10000);

    function solicitarBloqueo(username, bloqueado) {
      usuarioSeleccionado = username;
      accionBloqueo = bloqueado ? 'desbloquear' : 'bloquear';
      document.getElementById('tituloBloqueo').textContent = bloqueado ? 'Desbloquear Usuario' : 'Bloquear Usuario';
      document.getElementById('mensajeBloqueo').textContent = bloqueado ? 
        `¿Desbloquear a ${username}?` : 
        `¿Bloquear a ${username}? Quedará sin acceso al sistema.`;
      document.getElementById('modalBloqueo').classList.remove('hidden');
    }

    function cerrarModalBloqueo() {
      document.getElementById('modalBloqueo').classList.add('hidden');
      document.getElementById('passwordAdmin').value = '';
      usuarioSeleccionado = null;
    }

    async function confirmarBloqueo() {
      const password = document.getElementById('passwordAdmin').value;
      if (password !== '6511') {
        msg('Contraseña incorrecta', 'error');
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('usuarios')
          .update({ bloqueado: accionBloqueo === 'bloquear' })
          .eq('username', usuarioSeleccionado);

        if (error) throw error;
        
        msg(`Usuario ${accionBloqueo === 'bloquear' ? 'bloqueado' : 'desbloqueado'} correctamente`);
        cerrarModalBloqueo();
        cargarUsuarios();
      } catch (error) {
        msg('Error: ' + error.message, 'error');
      }
    }

    async function eliminarUsuario(username) {
      if (!confirm(`¿Eliminar usuario ${username}? Esta acción no se puede deshacer.`)) return;
      
      const respuesta = prompt('Escribe "ELIMINAR" para confirmar:');
      if (respuesta !== 'ELIMINAR') {
        msg('No se eliminó', 'warning');
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('usuarios')
          .delete()
          .eq('username', username);

        if (error) throw error;
        msg('Usuario eliminado correctamente');
        cargarUsuarios();
      } catch (error) {
        msg('Error: ' + error.message, 'error');
      }
    }

    function cerrarSesion() {
      localStorage.removeItem('usuario');
      localStorage.removeItem('fecha_sesion');
      window.location.href = 'login.html';
    }

    setInterval(async () => {
      const usuario = localStorage.getItem('usuario');
      if (usuario) {
        const usuarioObj = JSON.parse(usuario);
        try {
          await supabaseClient
            .from('usuarios')
            .update({ ultima_conexion: new Date().toISOString() })
            .eq('username', usuarioObj.username);
        } catch (e) {
          console.error('Error:', e);
        }
      }
    }, 30000);

    window.onload = () => {
      verificarAdmin();
      cargarUsuarios();
    };
  </script>
</body>
</html>
