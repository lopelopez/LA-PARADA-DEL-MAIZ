<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios - La Parada del Ma√≠z</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsstablenpm.toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* === DISE√ëO MODERNO === */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff7ed 100%);
      min-height: 100vh;
    }

    .banner {
      border-radius: 0 0 60px 60px;
      box-shadow: 0 15px 50px rgba(245, 158, 11, 0.3);
    }

    .nav-btn {
      border-radius: 16px;
      padding: 10px 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .nav-yellow {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .nav-yellow:hover {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .nav-red {
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
    }

    .nav-red:hover {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .input-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .input-modern:focus {
      border-color: #f59e0b;
      background: white;
      box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.15);
      outline: none;
    }

    .btn-primary {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.45);
    }

    .btn-danger {
      border-radius: 16px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
    }

    .card-usuario {
      background: linear-gradient(135deg, #ffffff, #fefbf4);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(245, 158, 11, 0.1);
      transition: all 0.3s ease;
    }

    .card-usuario:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(245, 158, 11, 0.15);
    }

    .badge-conectado {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      padding: 8px 16px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 700;
      color: #065f46;
      animation: pulse 2s infinite;
    }

    .badge-desconectado {
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      padding: 8px 16px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
    }

    .badge-sin-sesion {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      padding: 8px 16px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 600;
      color: #991b1b;
    }

    .badge-admin {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      color: #92400e;
    }

    .badge-fecha {
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #4338ca;
    }

    .badge-bloqueado {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      color: #991b1b;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #f59e0b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @media (max-width: 640px) {
      .glass-card {
        padding: 20px;
        border-radius: 22px;
      }
      
      .banner {
        border-radius: 0 0 45px 45px;
      }
    }
  </style>
</head>
<body>

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/50 to-yellow-600/60 flex items-center justify-center banner">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center px-4 drop-shadow-lg">
        üë• Gesti√≥n de Usuarios
      </h1>
    </div>
  </div>

  <!-- Navegaci√≥n -->
  <nav class="flex flex-wrap justify-center gap-3 mt-6 px-4">
    <a href="index.html" class="nav-btn nav-yellow text-sm">üì¶ Art√≠culos</a>
  </nav>

  <!-- Usuarios -->
  <section class="max-w-4xl mx-auto mt-6 mx-4 mb-10">
    <div class="glass-card">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üë• Usuarios Registrados</h2>

      <!-- Loading -->
      <div id="loading" class="flex justify-center py-8">
        <div class="loading-spinner"></div>
      </div>

      <!-- Lista de usuarios -->
      <div id="usuariosContainer" class="space-y-4"></div>
    </div>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Tiempo m√°ximo para considerar conectado (5 minutos)
    const TIEMPO_CONEXION = 5 * 60 * 1000; // 5 minutos en milisegundos

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function formatearFecha(fechaStr) {
      if (!fechaStr) return 'Sin registro';
      const fecha = new Date(fechaStr);
      return fecha.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Funci√≥n para determinar si un usuario est√° conectado
    function estaConectado(ultimaConexion) {
      if (!ultimaConexion) return false;
      
      const ahora = new Date().getTime();
      const ultima = new Date(ultimaConexion).getTime();
      const diferencia = ahora - ultima;
      
      // Si la diferencia es menor a 5 minutos, est√° conectado
      return diferencia < TIEMPO_CONEXION;
    }

    // Funci√≥n para obtener el estado del usuario
    function obtenerEstadoUsuario(ultimaConexion, activo) {
      // Si est√° bloqueado
      if (activo === false) {
        return { texto: 'Bloqueado', clase: 'badge-bloqueado', icono: 'üö´' };
      }
      
      // Si nunca ha iniciado sesi√≥n
      if (!ultimaConexion) {
        return { texto: 'Sin iniciar sesi√≥n', clase: 'badge-sin-sesion', icono: '‚ö™' };
      }
      
      // Verificar si est√° conectado (√∫ltima conexi√≥n en los √∫ltimos 5 minutos)
      if (estaConectado(ultimaConexion)) {
        return { texto: 'Conectado', clase: 'badge-conectado', icono: 'üü¢' };
      }
      
      // Si tiene √∫ltima conexi√≥n pero est√° fuera del tiempo de conexi√≥n
      return { texto: 'Desconectado', clase: 'badge-desconectado', icono: 'üî¥' };
    }

    async function cargarUsuarios() {
      try {
        const { data, error } = await supabaseClient
          .from('usuarios')
          .select('*')
          .order('id', { ascending: true });

        if (error) throw error;

        const container = document.getElementById('usuariosContainer');
        container.innerHTML = '';

        if (!data || data.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500">No hay usuarios registrados</p>';
          return;
        }

        data.forEach(usuario => {
          const estado = obtenerEstadoUsuario(usuario.ultima_conexion, usuario.activo);
          const esAdmin = usuario.rol === 'administrador';
          
          const card = document.createElement('div');
          card.className = 'card-usuario';
          card.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="font-bold text-lg text-gray-800">${usuario.username}</h3>
                  ${esAdmin ? '<span class="badge-admin">üëë Administrador</span>' : ''}
                  <span class="${estado.clase}">${estado.icono} ${estado.texto}</span>
                </div>
                <div class="flex flex-wrap gap-2">
                  <span class="badge-fecha">üìÖ √öltima: ${formatearFecha(usuario.ultima_conexion)}</span>
                </div>
              </div>
              <div class="flex gap-2">
                ${usuario.activo !== false ? `
                  <button onclick="bloquearUsuario('${usuario.username}')" class="btn-danger">üö´ Bloquear</button>
                ` : `
                  <button onclick="desbloquearUsuario('${usuario.username}')" class="btn-primary">‚úÖ Desbloquear</button>
                `}
                ${!esAdmin ? `
                  <button onclick="eliminarUsuario('${usuario.username}')" class="btn-danger">üóëÔ∏è Eliminar</button>
                ` : ''}
              </div>
            </div>
          `;
          container.appendChild(card);
        });

      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    async function bloquearUsuario(username) {
      if (!confirm(`¬øEst√°s seguro de que deseas bloquear al usuario "${username}"?`)) return;
      
      try {
        const { error } = await supabaseClient
          .from('usuarios')
          .update({ activo: false })
          .eq('username', username);
        
        if (error) throw error;
        
        mostrarNotificacion('‚úÖ Usuario bloqueado');
        cargarUsuarios();
        
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    async function desbloquearUsuario(username) {
      try {
        const { error } = await supabaseClient
          .from('usuarios')
          .update({ activo: true })
          .eq('username', username);
        
        if (error) throw error;
        
        mostrarNotificacion('‚úÖ Usuario desbloqueado');
        cargarUsuarios();
        
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    async function eliminarUsuario(username) {
      if (!confirm(`¬øEst√°s seguro de que deseas eliminar al usuario "${username}"? Esta acci√≥n no se puede deshacer.`)) return;
      
      try {
        const { error } = await supabaseClient
          .from('usuarios')
          .delete()
          .eq('username', username);
        
        if (error) throw error;
        
        mostrarNotificacion('‚úÖ Usuario eliminado');
        cargarUsuarios();
        
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    // Actualizar la lista cada 30 segundos para reflejar cambios en tiempo real
    setInterval(() => {
      cargarUsuarios();
    }, 30000);

    window.onload = () => {
      cargarUsuarios();
    };
  </script>
</body>
</html>
