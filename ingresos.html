<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cierre Semanal - La Parada del Ma√≠z</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff7ed 100%);
      min-height: 100vh;
    }

    .banner {
      border-radius: 0 0 60px 60px;
      box-shadow: 0 15px 50px rgba(245, 158, 11, 0.3);
    }

    .nav-btn {
      border-radius: 16px;
      padding: 10px 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .nav-yellow {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .nav-yellow:hover {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .input-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .input-modern:focus {
      border-color: #f59e0b;
      background: white;
      box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.15);
      outline: none;
    }

    .btn-search {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.35);
    }

    .btn-search:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.45);
    }

    .btn-print {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }

    .btn-print:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.45);
    }

    .card-dia {
      background: linear-gradient(135deg, #ffffff, #fefbf4);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(245, 158, 11, 0.1);
    }

    .card-dia:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 35px rgba(245, 158, 11, 0.12);
    }

    .badge-fecha {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      color: #92400e;
    }

    .badge-total {
      padding: 10px 20px;
      border-radius: 14px;
      font-weight: 700;
      font-size: 18px;
    }

    .badge-ingresos {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }

    .badge-gastos {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    .badge-balance-positivo {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
    }

    .badge-balance-negativo {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    .card-total-semana {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(245, 158, 11, 0.25);
      border: 2px solid rgba(245, 158, 11, 0.3);
    }

    .detalle-gasto {
      background: #fef2f2;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      border-left: 4px solid #ef4444;
    }

    .detalle-factura {
      background: #f0fdf4;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      border-left: 4px solid #22c55e;
    }

    .info-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    @media (max-width: 640px) {
      .glass-card {
        padding: 20px;
        border-radius: 22px;
      }
      
      .banner {
        border-radius: 0 0 45px 45px;
      }
    }
  </style>
</head>
<body>

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/50 to-yellow-600/60 flex items-center justify-center banner">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center px-4 drop-shadow-lg">
        üìä Cierre Semanal
      </h1>
    </div>
  </div>

  <!-- Navegaci√≥n -->
  <nav class="flex flex-wrap justify-center gap-3 mt-6 px-4">
    <a href="index.html" class="nav-btn nav-yellow text-sm">üì¶ Art√≠culos</a>
    <a href="historial.html" class="nav-btn nav-yellow text-sm">üìã Historial</a>
  </nav>

  <!-- Cierre Semanal -->
  <section class="max-w-4xl mx-auto mt-6 mx-4 mb-10">
    <div class="glass-card">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìä Cierre Semanal</h2>
      
      <!-- Info -->
      <div class="info-box mb-6">
        <p class="text-sm text-blue-700 text-center">
          üí° <strong>Tip:</strong> Selecciona el rango de fechas donde tienes facturas registradas
        </p>
      </div>
      
      <!-- Selector de fechas -->
      <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <div class="w-full sm:w-1/2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Desde:</label>
          <input type="date" id="fechaDesde" class="input-modern w-full">
        </div>
        <div class="w-full sm:w-1/2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Hasta:</label>
          <input type="date" id="fechaHasta" class="input-modern w-full">
        </div>
      </div>
      
      <button onclick="buscarCierre()" class="btn-search w-full mb-6">
        üîç Buscar Cierre
      </button>

      <!-- TOTAL GENERAL -->
      <div class="card-total-semana mb-6">
        <h3 class="text-lg font-bold text-yellow-800 mb-4 text-center">üí∞ TOTAL SEMANA</h3>
        <div class="text-center">
          <span class="text-4xl font-bold text-yellow-700">
            RD$ <span id="totalSemana">0.00</span>
          </span>
        </div>
      </div>

      <!-- LISTA DE D√çAS -->
      <div id="diasContainer" class="space-y-4">
        <p class="text-center text-gray-500">üîç Busca un rango de fechas para ver el cierre</p>
      </div>

      <!-- Bot√≥n imprimir -->
      <button onclick="mostrarModalImprimir()" id="btnImprimir" class="btn-print w-full mt-6 hidden">
        üñ®Ô∏è Imprimir Resumen
      </button>
    </div>
  </section>

  <!-- Modal Imprimir -->
  <div id="modalImprimir" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h3 class="text-lg font-semibold mb-4">Imprimir Resumen</h3>
      <div class="mb-4">
        <label class="block text-sm mb-1">Desde:</label>
        <input type="date" id="printDesde" class="border p-2 rounded w-full">
      </div>
      <div class="mb-4">
        <label class="block text-sm mb-1">Hasta:</label>
        <input type="date" id="printHasta" class="border p-2 rounded w-full">
      </div>
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalImprimir()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancelar</button>
        <button onclick="imprimirVentas()" class="bg-green-500 text-white px-4 py-2 rounded">Imprimir</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let datosCierre = null;

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function formatearFecha(fechaStr) {
      if (!fechaStr) return '--/--/----';
      
      const partes = fechaStr.split('-');
      if (partes.length !== 3) return fechaStr;
      
      const a√±o = parseInt(partes[0]);
      const mes = parseInt(partes[1]) - 1;
      const dia = parseInt(partes[2]);
      
      const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      const nombreDia = diasSemana[new Date(a√±o, mes, dia).getDay()];
      
      return `${nombreDia} ${String(dia).padStart(2, '0')}/${String(mes + 1).padStart(2, '0')}/${a√±o}`;
    }

    function obtenerFechaSolo(fechaInput) {
      if (!fechaInput) return null;
      
      if (fechaInput.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return fechaInput;
      }
      
      if (fechaInput.includes('T')) {
        return fechaInput.split('T')[0];
      }
      
      if (fechaInput.includes(' ')) {
        return fechaInput.split(' ')[0];
      }
      
      return fechaInput;
    }

    function mostrarModalImprimir() {
      document.getElementById('modalImprimir').classList.remove('hidden');
    }

    function cerrarModalImprimir() {
      document.getElementById('modalImprimir').classList.add('hidden');
    }

    async function buscarCierre() {
      const desde = document.getElementById('fechaDesde').value;
      const hasta = document.getElementById('fechaHasta').value;
      
      if (!desde || !hasta) {
        return mostrarNotificacion('‚ö†Ô∏è Selecciona las fechas desde y hasta', 'warning');
      }

      if (desde > hasta) {
        return mostrarNotificacion('‚ö†Ô∏è La fecha "Desde" no puede ser mayor que "Hasta"', 'warning');
      }

      try {
        const { data: facturas, error: errorFacturas } = await supabaseClient
          .from('facturas')
          .select('id, total, fecha')
          .gte('fecha', desde + 'T00:00:00')
          .lte('fecha', hasta + 'T23:59:59')
          .order('fecha', { ascending: false });

        if (errorFacturas) throw errorFacturas;

        const { data: gastos, error: errorGastos } = await supabaseClient
          .from('gastos')
          .select('id, monto, fecha, descripcion, caja_chica_id')
          .gte('fecha', desde + 'T00:00:00')
          .lte('fecha', hasta + 'T23:59:59')
          .order('fecha', { ascending: false });

        if (errorGastos) throw errorGastos;

        const cajaChicaIds = [...new Set(gastos?.map(g => g.caja_chica_id).filter(Boolean))];
        let cajasChicas = {};
        
        if (cajaChicaIds.length > 0) {
          const { data: cajas } = await supabaseClient
            .from('caja_chica')
            .select('id, fecha')
            .in('id', cajaChicaIds);
          
          if (cajas) {
            cajas.forEach(c => {
              cajasChicas[c.id] = c.fecha;
            });
          }
        }

        const diasMap = new Map();

        if (facturas && facturas.length > 0) {
          facturas.forEach(f => {
            const fechaKey = obtenerFechaSolo(f.fecha);
            if (!fechaKey) return;
            
            if (!diasMap.has(fechaKey)) {
              diasMap.set(fechaKey, {
                ingresos: 0,
                gastos: 0,
                listaGastos: [],
                listaFacturas: []
              });
            }
            
            const dia = diasMap.get(fechaKey);
            dia.ingresos += parseFloat(f.total || 0);
            dia.listaFacturas.push(f);
          });
        }

        if (gastos && gastos.length > 0) {
          gastos.forEach(g => {
            let fechaKey = obtenerFechaSolo(g.fecha);
            
            if (g.caja_chica_id && cajasChicas[g.caja_chica_id]) {
              fechaKey = obtenerFechaSolo(cajasChicas[g.caja_chica_id]);
            }
            
            if (!fechaKey) return;
            
            if (!diasMap.has(fechaKey)) {
              diasMap.set(fechaKey, {
                ingresos: 0,
                gastos: 0,
                listaGastos: [],
                listaFacturas: []
              });
            }
            
            const dia = diasMap.get(fechaKey);
            dia.gastos += parseFloat(g.monto || 0);
            dia.listaGastos.push(g);
          });
        }

        const diasArray = Array.from(diasMap.entries())
          .sort((a, b) => new Date(b[0]) - new Date(a[0]));

const diasConBalance = diasArray.map(([fecha, dia]) => {
  const balance = dia.ingresos - dia.gastos;

            return {
            fecha: fecha,
            ingresos: dia.ingresos,
            gastos: dia.gastos,
            balance: balance,
            listaGastos: dia.listaGastos,
            listaFacturas: dia.listaFacturas
          };
        });

        const totalSemana = diasConBalance.reduce((sum, d) => sum + d.balance, 0);

        datosCierre = { desde, hasta, diasConBalance, totalSemana };

        document.getElementById('totalSemana').textContent = totalSemana.toFixed(2);

        const container = document.getElementById('diasContainer');
        const btnImprimir = document.getElementById('btnImprimir');

        if (diasConBalance.length === 0) {
          container.innerHTML = `
            <div class="info-box">
              <p class="text-center text-blue-700">
                üì≠ No hay facturas ni gastos en el per√≠odo seleccionado<br>
                <span class="text-sm">(${formatearFecha(desde)} al ${formatearFecha(hasta)})</span>
              </p>
            </div>
          `;
          btnImprimir.classList.add('hidden');
        } else {
          btnImprimir.classList.remove('hidden');
          container.innerHTML = '';

          diasConBalance.forEach(dia => {
            const card = document.createElement('div');
            card.className = 'card-dia';
            
            const balanceClass = dia.balance >= 0 ? 'badge-balance-positivo' : 'badge-balance-negativo';
            const balanceSign = dia.balance >= 0 ? '+' : '';
            
            let gastosHTML = '';
            if (dia.listaGastos && dia.listaGastos.length > 0) {
              gastosHTML = `
                <div class="detalle-gasto">
                  <p class="text-sm font-semibold text-red-700 mb-2">üí∏ Gastos del d√≠a:</p>
                  ${dia.listaGastos.map(g => `
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">${g.descripcion || 'Gasto'}</span>
                      <span class="font-medium text-red-600">-RD$ ${parseFloat(g.monto).toFixed(2)}</span>
                    </div>
                  `).join('')}
                </div>
              `;
            }

            let facturasHTML = '';
            if (dia.listaFacturas && dia.listaFacturas.length > 0) {
              facturasHTML = `
                <div class="detalle-factura">
                  <p class="text-sm font-semibold text-green-700 mb-2">üí∞ Facturas del d√≠a (${dia.listaFacturas.length}):</p>
                  ${dia.listaFacturas.map(f => `
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">Factura #${f.id}</span>
                      <span class="font-medium text-green-600">RD$ ${parseFloat(f.total).toFixed(2)}</span>
                    </div>
                  `).join('')}
                </div>
              `;
            }

            card.innerHTML = `
              <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
                <span class="badge-fecha mb-2 sm:mb-0">üìÖ ${formatearFecha(dia.fecha)}</span>
                <div class="flex gap-3 flex-wrap">
                  <span class="badge-total badge-ingresos">üí∞ RD$ ${dia.ingresos.toFixed(2)}</span>
                  <span class="badge-total badge-gastos">üí∏ RD$ ${dia.gastos.toFixed(2)}</span>
                  <span class="badge-total ${balanceClass}">‚öñÔ∏è ${balanceSign}RD$ ${dia.balance.toFixed(2)}</span>
                </div>
              </div>
              ${facturasHTML}
              ${gastosHTML}
            `;
            container.appendChild(card);
          });
        }

      } catch (e) {
        mostrarNotificacion('‚ùå Error: ' + e.message, 'error');
        console.error('Error completo:', e);
      }
    }

    async function imprimirVentas() {
      const fd = document.getElementById('printDesde').value;
      const fh = document.getElementById('printHasta').value;
      
      if (!fd || !fh) {
        return mostrarNotificacion('Seleccione fechas', 'warning');
      }
      
      try {
        const { data: fs } = await supabaseClient
          .from('facturas')
          .select('*')
          .gte('fecha', fd + 'T00:00:00')
          .lte('fecha', fh + 'T23:59:59')
          .order('fecha', { ascending: true });

        if (!fs || fs.length === 0) {
          return mostrarNotificacion('No hay facturas en este periodo', 'warning');
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // === LOGO ===
        try { 
          doc.addImage('maiz.png', 'PNG', 10, 10, 25, 25); 
        } catch(e) {}

        // === HEADER ===
        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(245, 158, 11);
        doc.text("Resumen de Ingresos", 105, 22, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Periodo: ${fd} al ${fh}`, 105, 30, { align: "center" });
        doc.line(10, 35, 200, 35);

        let y = 45;

        // === TOTAL GENERAL ===
        const totalPeriodo = fs.reduce((sum, f) => sum + parseFloat(f.total), 0);
        
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(217, 119, 6);
        doc.text("TOTAL INGRESOS:", 105, y, { align: "center" });
        y += 10;
        
        doc.setFontSize(24);
        doc.text(`RD$ ${totalPeriodo.toFixed(2)}`, 105, y + 5, { align: "center" });
        y += 25;
        doc.line(10, y, 200, y);
        y += 10;

        // === INGRESOS POR D√çA ===
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        doc.text("INGRESOS POR DIA", 10, y);
        y += 10;

        const ventasPorFecha = {};
        fs.forEach(f => {
          const fecha = f.fecha.split('T')[0];
          if (!ventasPorFecha[fecha]) {
            ventasPorFecha[fecha] = { total: 0, cantidad: 0 };
          }
          ventasPorFecha[fecha].total += parseFloat(f.total);
          ventasPorFecha[fecha].cantidad += 1;
        });

        Object.keys(ventasPorFecha).forEach(fecha => {
          if (y > 260) {
            doc.addPage();
            y = 20;
          }

          const dia = ventasPorFecha[fecha];
          
          doc.setFillColor(255, 250, 240);
          doc.roundedRect(10, y - 3, 190, 10, 2, 2, 'F');
          
          doc.setFontSize(11);
          doc.setFont("helvetica", "bold");
          doc.setTextColor(100, 100, 100);
          doc.text(formatearFecha(fecha), 15, y + 3);
          
          doc.setTextColor(5, 150, 105);
          doc.text(`RD$ ${dia.total.toFixed(2)}`, 195, y + 3, { align: "right" });
          
          y += 12;
        });

        // === FOOTER ===
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Generado el: ${new Date().toLocaleString()}`, 105, 285, { align: "center" });

        doc.save(`Ingresos_${fd}_al_${fh}.pdf`);
        cerrarModalImprimir();
        mostrarNotificacion('PDF generado correctamente');
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    // Actualizar conexi√≥n cada 30 segundos
    setInterval(async () => {
      const usuario = localStorage.getItem('usuario');
      if (usuario) {
        const usuarioObj = JSON.parse(usuario);
        try {
          await supabaseClient
            .from('usuarios')
            .update({ ultima_conexion: new Date().toISOString() })
            .eq('username', usuarioObj.username);
        } catch (e) {
          console.error('Error actualizando conexi√≥n:', e);
        }
      }
    }, 30000);

    window.onload = () => {
      // Campos vac√≠os para que el usuario seleccione las fechas
    };
  </script>
</body>
</html>
