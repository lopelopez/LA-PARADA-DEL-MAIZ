<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingresos - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center">Cierre Semanal</h1>
    </div>
  </div>

  <nav class="flex flex-wrap justify-center gap-2 mt-4 px-2">
    <a href="index.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Artículos</a>
  </nav>

  <section class="max-w-4xl mx-auto mt-6 bg-white p-4 rounded-xl shadow mx-2">
    <h2 class="text-2xl font-semibold mb-4 text-center">Cierre Semanal - Totales</h2>
    
    <!-- Selector de semana -->
    <div class="flex flex-col sm:flex-row gap-3 mb-4">
      <div class="w-full sm:w-1/2">
        <label class="block text-sm mb-1">Desde:</label>
        <input type="date" id="fechaDesde" class="border p-2 rounded w-full">
      </div>
      <div class="w-full sm:w-1/2">
        <label class="block text-sm mb-1">Hasta:</label>
        <input type="date" id="fechaHasta" class="border p-2 rounded w-full">
      </div>
    </div>
    
    <button onclick="buscarCierre()" class="bg-yellow-400 text-white px-6 py-2 rounded w-full mb-4">Buscar</button>

    <!-- RESUMEN TOTAL -->
    <div class="bg-green-100 p-4 rounded-lg mb-4">
      <h3 class="font-semibold text-lg mb-2 text-green-800">TOTAL INGRESOS</h3>
      <div class="text-3xl font-bold text-green-600">
        RD$ <span id="totalIngresos">0.00</span>
      </div>
    </div>

    <div class="bg-red-100 p-4 rounded-lg mb-4">
      <h3 class="font-semibold text-lg mb-2 text-red-800">TOTAL GASTOS</h3>
      <div class="text-3xl font-bold text-red-600">
        RD$ <span id="totalGastos">0.00</span>
      </div>
    </div>

    <div class="bg-yellow-100 p-4 rounded-lg mb-4">
      <h3 class="font-semibold text-lg mb-2 text-yellow-800">BALANCE FINAL</h3>
      <div class="text-3xl font-bold text-yellow-600">
        RD$ <span id="balanceFinal">0.00</span>
      </div>
    </div>

    <!-- Botón imprimir -->
    <button onclick="imprimirCierre()" class="bg-green-400 text-white px-6 py-2 rounded w-full">Imprimir Cierre Semanal</button>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let datosCierre = null;

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function obtenerSemanaActual() {
      const hoy = new Date();
      const inicio = new Date(hoy);
      inicio.setDate(hoy.getDate() - hoy.getDay());
      const fin = new Date(inicio);
      fin.setDate(inicio.getDate() + 6);
      return { desde: inicio.toISOString().split('T')[0], hasta: fin.toISOString().split('T')[0] };
    }

    async function buscarCierre() {
      const desde = document.getElementById('fechaDesde').value;
      const hasta = document.getElementById('fechaHasta').value;
      
      if (!desde || !hasta) return mostrarNotificacion('Seleccione fechas', 'warning');

      try {
        // TOTAL INGRESOS (suma de todas las facturas)
        const { data: facturas } = await supabaseClient
          .from('facturas')
          .select('total')
          .gte('fecha', desde + 'T00:00:00')
          .lte('fecha', hasta + 'T23:59:59');

        const totalIngresos = facturas ? facturas.reduce((sum, f) => sum + parseFloat(f.total || 0), 0) : 0;

        // TOTAL GASTOS (suma de todos los gastos en el período)
        const { data: gastos } = await supabaseClient
          .from('gastos')
          .select('monto')
          .gte('fecha', desde + 'T00:00:00')
          .lte('fecha', hasta + 'T23:59:59');

        const totalGastos = gastos ? gastos.reduce((sum, g) => sum + parseFloat(g.monto || 0), 0) : 0;

        // BALANCE
        const balance = totalIngresos - totalGastos;

        // GUARDAR DATOS
        datosCierre = { desde, hasta, totalIngresos, totalGastos, balance };

        // MOSTRAR
        document.getElementById('totalIngresos').textContent = totalIngresos.toFixed(2);
        document.getElementById('totalGastos').textContent = totalGastos.toFixed(2);
        document.getElementById('balanceFinal').textContent = balance.toFixed(2);

      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    async function imprimirCierre() {
      if (!datosCierre) return mostrarNotificacion('Busque primero', 'warning');

      const { desde, hasta, totalIngresos, totalGastos, balance } = datosCierre;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      try { doc.addImage('LOGO LA PARADA DEL MAIZ.png', 'PNG', 10, 10, 30, 30); } catch(e) {}

      doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.setTextColor(255, 193, 7);
      doc.text("Cierre Semanal de Caja", 105, 20, { align: "center" });
      doc.setFontSize(12); doc.setTextColor(0, 0, 0);
      doc.text(`Período: ${desde} al ${hasta}`, 105, 30, { align: "center" });
      doc.line(10, 35, 200, 35);

      let y = 50;

      doc.setFontSize(14); doc.setFont("helvetica", "bold");
      doc.text("RESUMEN DE LA SEMANA", 10, y); y += 15;

      // Ingresos
      doc.setTextColor(0, 150, 0);
      doc.setFontSize(12);
      doc.text("TOTAL INGRESOS:", 15, y); 
      doc.text(`RD$${totalIngresos.toFixed(2)}`, 150, y, { align: "right" }); y += 12;

      // Gastos
      doc.setTextColor(200, 0, 0);
      doc.text("TOTAL GASTOS:", 15, y);
      doc.text(`RD$${totalGastos.toFixed(2)}`, 150, y, { align: "right" }); y += 12;

      // Línea
      doc.setTextColor(0, 0, 0);
      doc.line(15, y, 195, y); y += 10;

      // Balance
      doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.setTextColor(200, 150, 0);
      doc.text("BALANCE FINAL:", 15, y);
      doc.text(`RD$${balance.toFixed(2)}`, 150, y, { align: "right" }); y += 20;

      // Footer
      doc.setFontSize(10); doc.setTextColor(100, 100, 100);
      doc.text(`Generado el: ${new Date().toLocaleString()}`, 105, y, { align: "center" });

      doc.save(`Cierre_Semanal_${desde}_al_${hasta}.pdf`);
      mostrarNotificacion('PDF generado');
    }
    setInterval(async () => {
  const usuario = localStorage.getItem('usuario');
  if (usuario) {
    const usuarioObj = JSON.parse(usuario);
    try {
      await supabaseClient
        .from('usuarios')
        .update({ ultima_conexion: new Date().toISOString() })
        .eq('username', usuarioObj.username);
    } catch (e) {
      console.error('Error actualizando conexión:', e);
    }
  }
}, 30000);

    window.onload = () => {
      const semana = obtenerSemanaActual();
      document.getElementById('fechaDesde').value = semana.desde;
      document.getElementById('fechaHasta').value = semana.hasta;
      buscarCierre();
    };
  </script>
</body>
</html>
