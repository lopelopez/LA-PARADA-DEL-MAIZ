<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historial - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center">La Parada del Maíz y El Majarete de Leidy</h1>
    </div>
  </div>

  <nav class="flex flex-wrap justify-center gap-2 mt-4 px-2">
    <a href="index.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Artículos</a>
    <a href="facturacion.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Facturación</a>
    <button onclick="mostrarModalImprimir()" class="bg-green-400 text-white px-4 py-2 rounded shadow text-sm">Imprimir</button>
   <button onclick="mostrarModalIngresos()" class="bg-green-400 text-white px-4 py-2 rounded shadow text-sm">Ingresos</button>
  </nav>

  <section class="max-w-4xl mx-auto mt-6 bg-white p-4 rounded-xl shadow mx-2">
    <h2 class="text-2xl font-semibold mb-4 text-center">Historial de Facturas</h2>
    
    <div class="flex flex-col sm:flex-row gap-3 justify-center mb-4">
      <div><label class="block text-sm">Desde:</label><input type="date" id="fechaDesde" class="border p-2 rounded w-full"></div>
      <div><label class="block text-sm">Hasta:</label><input type="date" id="fechaHasta" class="border p-2 rounded w-full"></div>
      <button onclick="cargarFacturasPorRango()" class="bg-yellow-400 text-white px-4 py-2 rounded shadow sm:self-end">Buscar</button>
    </div>

    <ul id="historialFacturas" class="space-y-2"></ul>
    <div id="noData" class="text-center text-gray-500 mt-4 hidden">No hay facturas</div>
  </section>

  <!-- Modal Eliminar -->
  <div id="modalPassword" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white p-4 rounded-lg w-full max-w-sm">
      <h3 class="font-semibold mb-2">Eliminar factura</h3>
      <input type="password" id="inputPassword" class="border p-2 rounded w-full mb-4" placeholder="Contraseña">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModal()" class="bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
        <button onclick="confirmarEliminar()" class="bg-red-400 text-white px-3 py-2 rounded">Eliminar</button>
      </div>
    </div>
  </div>
<!-- Modal Contraseña Ingresos -->
  <div id="modalPasswordIngresos" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white p-4 rounded-lg w-full max-w-sm">
      <h3 class="font-semibold mb-2">Ingresos - Contraseña</h3>
      <input type="password" id="inputPasswordIngresos" class="border p-2 rounded w-full mb-4" placeholder="Contraseña">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalIngresos()" class="bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
        <button onclick="confirmarPasswordIngresos()" class="bg-green-400 text-white px-3 py-2 rounded">Aceptar</button>
      </div>
    </div>
  </div>
  <!-- Modal Imprimir -->
  <div id="modalPasswordImprimir" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white p-4 rounded-lg w-full max-w-sm">
      <h3 class="font-semibold mb-2">Contraseña</h3>
      <input type="password" id="inputPasswordImprimir" class="border p-2 rounded w-full mb-4" placeholder="Contraseña">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalImprimir()" class="bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
        <button onclick="confirmarPasswordImprimir()" class="bg-green-400 text-white px-3 py-2 rounded">Aceptar</button>
      </div>
    </div>
  </div>

  <div id="modalImprimir" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white p-4 rounded-lg w-full max-w-sm">
      <h3 class="font-semibold mb-2">Imprimir Ventas</h3>
      <div class="mb-2"><label class="text-sm">Desde:</label><input type="date" id="printDesde" class="border p-2 rounded w-full"></div>
      <div class="mb-2"><label class="text-sm">Hasta:</label><input type="date" id="printHasta" class="border p-2 rounded w-full"></div>
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalImprimir()" class="bg-gray-400 text-white px-3 py-2 rounded">Cancelar</button>
        <button onclick="imprimirVentas()" class="bg-green-400 text-white px-3 py-2 rounded">Imprimir</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let facturaAEliminar = null;

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : tipo === 'warning' ? "#ffc107" : "#28a745"
      }).showToast();
    }

    function formatearFecha(fechaStr) {
      if (!fechaStr) return '';
      return fechaStr.split('T')[0].split('-').reverse().join('/');
    }

    async function cargarFacturas() {
      try {
        const hoy = new Date();
        const fechaHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
        const { data } = await supabaseClient.from('facturas').select('*').gte('fecha', fechaHoy+'T00:00:00').lte('fecha', fechaHoy+'T23:59:59').order('id', {ascending:false});
        mostrarFacturas(data || []);
      } catch (error) { mostrarNotificacion("Error: " + error.message, 'error'); }
    }

    function mostrarFacturas(data) {
      const lista = document.getElementById('historialFacturas');
      const noData = document.getElementById('noData');
      lista.innerHTML = "";
      if(data.length===0){ noData.classList.remove('hidden'); return; }
      noData.classList.add('hidden');
      data.forEach(f => {
        const li = document.createElement('li');
        li.className = "flex justify-between items-center bg-yellow-100 p-3 rounded-lg";
        li.innerHTML = `<div><span class="font-bold">#${f.id}</span> | ${formatearFecha(f.fecha)} | <span class="font-medium">RD$${parseFloat(f.total).toFixed(2)}</span></div>
          <div class="flex gap-2"><button onclick="window.location.href='detalle_factura.html?id=${f.id}'" class="bg-yellow-400 text-white px-2 py-1 rounded text-sm">Detalle</button>
          <button onclick="eliminarFactura(${f.id})" class="bg-red-400 text-white px-2 py-1 rounded text-sm">X</button></div>`;
        lista.appendChild(li);
      });
    }

    async function cargarFacturasPorRango() {
      const d = document.getElementById('fechaDesde').value;
      const h = document.getElementById('fechaHasta').value;
      if(!d||!h) return mostrarNotificacion('Seleccione fechas','warning');
      const { data } = await supabaseClient.from('facturas').select('*').gte('fecha',d+'T00:00:00').lte('fecha',h+'T23:59:59').order('id',{ascending:false});
      mostrarFacturas(data||[]);
    }

    function eliminarFactura(id){ facturaAEliminar=id; document.getElementById('modalPassword').classList.remove('hidden'); }
    function cerrarModal(){ facturaAEliminar=null; document.getElementById('inputPassword').value=''; document.getElementById('modalPassword').classList.add('hidden'); }

    async function confirmarEliminar(){
      if(document.getElementById('inputPassword').value!=='6511') return mostrarNotificacion('Contraseña incorrecta','error');
      try{
        const {data:dets} = await supabaseClient.from('detalle_factura').select('articulo_id,cantidad').eq('factura_id',facturaAEliminar);
        for(const d of dets){
          const {data:a} = await supabaseClient.from('articulos').select('stock').eq('id',d.articulo_id).single();
          if(a) await supabaseClient.from('articulos').update({stock:(a.stock||0)+d.cantidad}).eq('id',d.articulo_id);
        }
        await supabaseClient.from('detalle_factura').delete().eq('factura_id',facturaAEliminar);
        await supabaseClient.from('facturas').delete().eq('id',facturaAEliminar);
        mostrarNotificacion('Eliminado correctamente');
        cerrarModal(); cargarFacturas();
      }catch(e){ mostrarNotificacion('Error: '+e.message,'error'); }
    }

    function mostrarModalImprimir(){ document.getElementById('modalPasswordImprimir').classList.remove('hidden'); }
    function cerrarModalImprimir(){ document.getElementById('modalPasswordImprimir').classList.add('hidden'); document.getElementById('modalImprimir').classList.add('hidden'); document.getElementById('inputPasswordImprimir').value=''; }
    function confirmarPasswordImprimir(){ document.getElementById('inputPasswordImprimir').value!=='6511'?mostrarNotificacion('Incorrecto','error'):(document.getElementById('modalPasswordImprimir').classList.add('hidden'),document.getElementById('modalImprimir').classList.remove('hidden')); }
// Modal Ingresos
    function mostrarModalIngresos(){ document.getElementById('modalPasswordIngresos').classList.remove('hidden'); }
    function cerrarModalIngresos(){ document.getElementById('modalPasswordIngresos').classList.add('hidden'); document.getElementById('inputPasswordIngresos').value=''; }
    function confirmarPasswordIngresos(){ 
      if(document.getElementById('inputPasswordIngresos').value!=='6511'){
        return mostrarNotificacion('Contraseña incorrecta','error');
      }
      window.location.href='ingresos.html';
    }
    //funcion imprimir ventas 
            async function imprimirVentas(){
      const fd = document.getElementById('printDesde').value;
      const fh = document.getElementById('printHasta').value;
      if(!fd||!fh) return mostrarNotificacion('Seleccione fechas','warning');
      try{
        // VENTAS
        const {data:fs} = await supabaseClient.from('facturas').select('*').gte('fecha',fd+'T00:00:00').lte('fecha',fh+'T23:59:59').order('id',{ascending:true});
        
        // CAJA CHICA
        const {data:cajas} = await supabaseClient.from('caja_chica').select('*').gte('fecha',fd).lte('fecha',fh);
        
        // ARTÍCULOS DEFECTUOSOS POR DÍA
        const {data:defectuosos} = await supabaseClient.from('articulos_defectuosos').select('*,articulos(nombre)').gte('fecha',fd+'T00:00:00').lte('fecha',fh+'T23:59:59').order('fecha',{ascending:true});

        // STOCK ACTUAL
        const {data:articulos} = await supabaseClient.from('articulos').select('*').order('nombre',{ascending:true});

        if((!fs||fs.length===0) && (!cajas||cajas.length===0) && (!defectuosos||defectuosos.length===0) && (!articulos||articulos.length===0)) return mostrarNotificacion('No hay datos en este período','warning');

        const ids = fs ? fs.map(f=>f.id) : [];
        const {data:dets} = ids.length>0 ? await supabaseClient.from('detalle_factura').select('factura_id,cantidad,precio,subtotal,articulos(nombre),facturas(comentario,descuento)').in('factura_id',ids) : {data:[]};

        const xf={}, comentarios={};
        dets.forEach(d=>{
          if(!xf[d.factura_id]) xf[d.factura_id]=[];
          xf[d.factura_id].push(d);
          if(d.facturas&&d.facturas.comentario) comentarios[d.factura_id]=d.facturas.comentario;
        });

        // Calcular ventas por artículo
        const infoArticulos={};
        let totalArticulos=0, totalDescuentos=0;
        dets.forEach(d=>{
          const nom=d.articulos.nombre;
          const factura = fs?.find(f=>f.id===d.factura_id);
          const descuento = parseFloat(factura?.descuento||0);
          const itemsFactura = dets.filter(x=>x.factura_id===d.factura_id);
          const subtotalFactura = itemsFactura.reduce((sum,x)=>sum+x.subtotal,0);
          let precioReal = d.subtotal;
          if(descuento>0 && subtotalFactura>0){
            const proporcion = d.subtotal / subtotalFactura;
            precioReal = d.subtotal - (descuento * proporcion);
          }
          if(!infoArticulos[nom]) infoArticulos[nom]={cantidad:0,totalVenta:0};
          infoArticulos[nom].cantidad+=d.cantidad;
          infoArticulos[nom].totalVenta+=precioReal;
          totalArticulos+=d.cantidad;
        });
        fs?.forEach(f=>{ totalDescuentos+=parseFloat(f.descuento||0); });

        // Totales caja chica
        let totalInicialCaja=0, totalGastosCaja=0, totalFinalCaja=0;
        if(cajas && cajas.length>0){
          cajas.forEach(c=>{ 
            totalInicialCaja+=c.monto_inicial; 
            totalGastosCaja+=c.monto_gastos;
            totalFinalCaja+=c.monto_final;
          });
        }

        // Organizar defectuosos por fecha
        const defectuososPorFecha={};
        if(defectuosos && defectuosos.length>0){
          defectuosos.forEach(d=>{
            const fecha = d.fecha.split('T')[0];
            if(!defectuososPorFecha[fecha]) defectuososPorFecha[fecha]=[];
            defectuososPorFecha[fecha].push(d);
          });
        }

        const {jsPDF}=window.jspdf;
        const doc=new jsPDF();
        try{doc.addImage('LOGO LA PARADA DEL MAIZ.png','PNG',10,10,30,30);}catch(e){}

        doc.setFontSize(18);doc.setFont("helvetica","bold");doc.setTextColor(255,193,7);
        doc.text("La Parada del Maiz y El Majarete de Leidy",105,20,{align:"center"});
        doc.setFontSize(14);doc.setTextColor(0,0,0);
        doc.text(`Resumen del: ${fd} al ${fh}`,105,30,{align:"center"});
        doc.line(10,35,200,35);

        let y=45,totalPeriodo=0;
        
        // === DETALLES DE CADA FACTURA ===
        if(fs && fs.length>0){
          doc.setFontSize(12);doc.setFont("helvetica","bold");
          doc.text("Detalles de Ventas:",10,y);y+=10;

          for(const f of fs){
            const com=comentarios[f.id];
            doc.setFont("helvetica","normal");
            doc.text(`Factura #${f.id} | ${formatearFecha(f.fecha)} | RD$${parseFloat(f.total).toFixed(2)}`,10,y);
            totalPeriodo+=parseFloat(f.total);y+=6;
            if(com&&com.trim()!==""){
              doc.setTextColor(0,100,200);
              const comentarioLimpio = com.replace(/[^\x00-\x7F]/g, '');
              doc.text(`  Nota: ${comentarioLimpio}`,15,y);
              doc.setTextColor(0,0,0);y+=6;
            }
            (xf[f.id]||[]).forEach(i=>{
              doc.text(`  - ${i.articulos.nombre} | Cant:${i.cantidad} | P:RD$${i.precio} | Sub:RD$${i.subtotal}`,15,y);y+=6;
            });
            y+=4;
            if(y>250){doc.addPage();y=20;}
          }
        }

        // === RESUMEN POR ARTÍCULO ===
        y+=10;doc.setFont("helvetica","bold");doc.setFontSize(12);
        doc.text("Resumen por Articulo:",10,y);y+=10;doc.setFont("helvetica","normal");doc.setFontSize(10);
        Object.keys(infoArticulos).forEach(nom=>{
          const info=infoArticulos[nom];
          const promedio = info.totalVenta / info.cantidad;
          doc.text(`${nom}:`,10,y);y+=5;
          doc.text(`  Cantidad total: ${info.cantidad}`,15,y);y+=5;
          doc.text(`  Suma total: RD$${info.totalVenta.toFixed(2)}`,15,y);y+=5;
          doc.text(`  Precio promedio de venta: RD$${promedio.toFixed(2)}`,15,y);y+=8;
          if(y>270){doc.addPage();y=20;}
        });

        // === CAJA CHICA ===
        if(cajas && cajas.length>0){
          y+=10;
          doc.setFont("helvetica","bold");doc.setFontSize(12);doc.setTextColor(200,0,0);
          doc.text("Caja Chica:",10,y);y+=8;
          doc.setFont("helvetica","normal");doc.setFontSize(10);doc.setTextColor(0,0,0);
          doc.text(`Total monto inicial: RD$${totalInicialCaja.toFixed(2)}`,15,y);y+=6;
          doc.text(`Total gastos: RD$${totalGastosCaja.toFixed(2)}`,15,y);y+=6;
          doc.setFont("helvetica","bold");
          doc.text(`Dinero en caja: RD$${totalFinalCaja.toFixed(2)}`,15,y);y+=10;
        }

        // === ARTÍCULOS DEFECTUOSOS POR DÍA ===
        if(defectuosos && defectuosos.length>0){
          if(y>230){doc.addPage();y=20;}
          y+=5;
          doc.setFont("helvetica","bold");doc.setFontSize(12);doc.setTextColor(150,0,0);
          doc.text("Articulos Defectuosos por Dia:",10,y);y+=10;
          
          Object.keys(defectuososPorFecha).forEach(fecha=>{
            doc.setFont("helvetica","bold");doc.setFontSize(10);doc.setTextColor(0,0,0);
            doc.text(`Fecha: ${formatearFecha(fecha)}`,15,y);y+=6;
            doc.setFont("helvetica","normal");doc.setFontSize(9);
            
            let totalDefDia=0;
            defectuososPorFecha[fecha].forEach(d=>{
              totalDefDia+=d.cantidad;
              doc.text(`  - ${d.articulos.nombre}: ${d.cantidad} uds (${d.descripcion})`,20,y);y+=5;
            });
            doc.setFont("helvetica","bold");doc.setFontSize(9);
            doc.text(`  Total del dia: ${totalDefDia} unidades`,20,y);y+=8;
            
            if(y>270){doc.addPage();y=20;}
          });
        }

        // === STOCK DISPONIBLE ===
        if(articulos && articulos.length>0){
          if(y>230){doc.addPage();y=20;}
          y+=5;
          doc.setFont("helvetica","bold");doc.setFontSize(12);doc.setTextColor(0,100,0);
          doc.text("Stock Disponible (Actual):",10,y);y+=10;
          
          doc.setFont("helvetica","normal");doc.setFontSize(9);doc.setTextColor(0,0,0);
          articulos.forEach(a=>{
            const stock = a.stock || 0;
            doc.text(`${a.nombre}: ${stock} unidades`,15,y);y+=5;
            if(y>270){doc.addPage();y=20;}
          });
        }

        // === TOTALES FINALES ===
        y+=10;doc.setFont("helvetica","bold");doc.setFontSize(14);doc.setTextColor(255,193,7);
        doc.text(`TOTAL VENTAS: RD$${totalPeriodo.toFixed(2)}`,105,y,{align:"center"});y+=8;
        doc.text(`Total articulos vendidos: ${totalArticulos}`,105,y,{align:"center"});y+=8;
        doc.text(`Total descuentos: RD$${totalDescuentos.toFixed(2)}`,105,y,{align:"center"});y+=10;
        
        // Balance: Ventas + Dinero en caja
        const balanceFinal = totalPeriodo + totalFinalCaja;
        doc.setFontSize(16);
        doc.text(`BALANCE FINAL (Ventas + Caja): RD$${balanceFinal.toFixed(2)}`,105,y,{align:"center"});

        doc.save(`Resumen_${fd}_al_${fh}.pdf`);
        cerrarModalImprimir();
        mostrarNotificacion('PDF generado correctamente');
      }catch(e){ mostrarNotificacion('Error: '+e.message,'error'); }
    }
    window.onload = cargarFacturas;
  </script>
</body>
</html>
