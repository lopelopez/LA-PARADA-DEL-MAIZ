<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>La Parada del Maíz y El Majarete de Leidy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    @media (max-width: 640px) {
      .nav-btn {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
      }
    }
  </style>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36 md:h-48 lg:h-56">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo de La Parada del Maíz" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center px-2">
      <h1 class="text-white text-lg sm:text-xl md:text-3xl lg:text-4xl font-bold text-center drop-shadow-lg">
        La Parada del Maíz y El Majarete de Leidy
      </h1>
    </div>
  </div>

  <!-- Navegación -->
    <nav class="flex flex-wrap justify-center gap-2 sm:gap-3 mt-4 px-2" role="navigation" aria-label="Navegación principal">
    <a href="index.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Artículos</a>
     <a href="cajachica.html" class="bg-red-400 text-white px-4 py-2 rounded shadow text-sm">Caja Chica</a>
    <a href="facturacion.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Ir a Facturación</a>
    <a href="historial.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Ver Historial</a>
    <a href="articulos_defectuosos.html" class="nav-btn bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Defectuosos</a>
    <button onclick="cerrarSesion()" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Cerrar Sesión</button>
  </nav>

  <!-- Crear Artículo -->
  <section class="max-w-4xl mx-auto mt-6 sm:mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow mx-2 sm:mx-4 lg:mx-auto" role="region" aria-labelledby="crear-articulo">
    <h2 id="crear-articulo" class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">Crear Artículo</h2>

    <div class="flex flex-col gap-3 mb-4">
      <input type="text" id="nombre" placeholder="Nombre del artículo" maxlength="100"
             class="border border-gray-300 p-2 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-yellow-400 text-sm sm:text-base" aria-label="Nombre del artículo">
      <div class="flex flex-col sm:flex-row gap-3">
        <input type="number" id="precio" placeholder="Precio (RD$)" min="0" step="0.01"
               class="border border-gray-300 p-2 rounded-lg w-full sm:w-1/2 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-sm sm:text-base" aria-label="Precio del artículo">
        <input type="number" id="stock" placeholder="Cantidad disponible" min="0" step="1"
               class="border border-gray-300 p-2 rounded-lg w-full sm:w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm sm:text-base" aria-label="Cantidad disponible">
      </div>
    </div>
    <button id="guardarBtn" onclick="guardarArticulo()"
            class="w-full sm:w-auto bg-yellow-400 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-600 text-sm sm:text-base">
      Guardar
    </button>
    <div id="loading" class="hidden mt-2 text-yellow-600 text-sm">Guardando...</div>
  </section>

  <!-- Lista de Artículos -->
  <section class="max-w-4xl mx-auto mt-6 sm:mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow mx-2 sm:mx-4 lg:mx-auto" role="region" aria-labelledby="lista-articulos">
    <h3 id="lista-articulos" class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">Lista de Artículos</h3>

    <!-- Vista de tabla para desktop -->
    <div class="hidden sm:block overflow-x-auto">
      <table class="min-w-full border border-gray-200 divide-y divide-gray-200" role="table" aria-label="Lista de artículos">
        <thead class="bg-yellow-100">
          <tr>
            <th class="px-4 py-2 text-left text-gray-700 text-sm" scope="col">Nombre</th>
            <th class="px-4 py-2 text-left text-gray-700 text-sm" scope="col">Precio (RD$)</th>
            <th class="px-4 py-2 text-center text-gray-700 text-sm" scope="col">Disponible</th>
            <th class="px-4 py-2 text-center text-gray-700 text-sm" scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody id="listaDesktop" class="divide-y divide-gray-100" role="rowgroup"></tbody>
      </table>
    </div>

    <!-- Vista de tarjetas para móvil -->
    <div id="listaMobile" class="sm:hidden space-y-3"></div>

    <div id="noData" class="text-center text-gray-500 mt-4 hidden text-sm">No hay artículos registrados.</div>
  </section>

  <!-- Modal de confirmación para eliminar -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h3 id="confirmTitle" class="text-base sm:text-lg font-semibold mb-4">Confirmar Eliminación</h3>
      <p class="text-sm sm:text-base mb-3">¿Estás seguro de que deseas eliminar este artículo?</p>
      <input type="password" id="deletePassword" placeholder="Ingrese contraseña" class="border border-gray-300 p-2 rounded w-full mb-4 focus:outline-none focus:ring-2 focus:ring-red-400 text-sm sm:text-base" aria-label="Contraseña para eliminar">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModal()" class="px-3 sm:px-4 py-2 bg-gray-300 rounded text-sm sm:text-base">Cancelar</button>
        <button id="confirmDelete" onclick="confirmarEliminar()" class="px-3 sm:px-4 py-2 bg-red-500 text-white rounded text-sm sm:text-base">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal de contraseña para editar -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h3 id="editTitle" class="text-base sm:text-lg font-semibold mb-4">Confirmar Edición</h3>
      <p class="text-sm sm:text-base mb-3">Ingrese contraseña para editar este artículo.</p>
      <input type="password" id="editPassword" placeholder="Ingrese contraseña" class="border border-gray-300 p-2 rounded w-full mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-sm sm:text-base" aria-label="Contraseña para editar">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalEditar()" class="px-3 sm:px-4 py-2 bg-gray-300 rounded text-sm sm:text-base">Cancelar</button>
        <button onclick="confirmarEditar()" class="px-3 sm:px-4 py-2 bg-yellow-500 text-white rounded text-sm sm:text-base">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal para agregar stock -->
  <div id="stockModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4" role="dialog" aria-modal="true" aria-labelledby="stockTitle">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h3 id="stockTitle" class="text-base sm:text-lg font-semibold mb-4">Agregar Inventario</h3>
      <p class="text-sm text-gray-600 mb-2">Artículo: <span id="stockArticuloNombre" class="font-medium"></span></p>
      <p class="text-sm text-gray-600 mb-3">Stock actual: <span id="stockActual" class="font-medium"></span></p>
      <input type="number" id="cantidadAgregar" placeholder="Cantidad a agregar" min="1"
             class="border border-gray-300 p-2 rounded w-full mb-4 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
      <input type="password" id="stockPassword" placeholder="Ingrese contraseña" class="border border-gray-300 p-2 rounded w-full mb-4 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm sm:text-base" aria-label="Contraseña para agregar stock">
      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalStock()" class="px-3 sm:px-4 py-2 bg-gray-300 rounded text-sm sm:text-base">Cancelar</button>
        <button onclick="confirmarAgregarStock()" class="px-3 sm:px-4 py-2 bg-blue-500 text-white rounded text-sm sm:text-base">Agregar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === VERIFICACIÓN DE AUTENTICACIÓN ===
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Verificar si está logueado
    (function() {
      const usuario = localStorage.getItem('usuario');
      if (!usuario) {
        window.location.href = 'login.html';
      }
    })();

    // === VARIABLES ===
    let editandoId = null;
    let articuloAEliminar = null;
    let articuloParaStock = null;
    let articuloParaEditar = null;

    // === FUNCIONES ===
    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : tipo === 'warning' ? "#ffc107" : "#28a745",
      }).showToast();
    }

    function cerrarSesion() {
      localStorage.removeItem('usuario');
      window.location.href = 'login.html';
    }

    function editarArticulo(id, nombre, precio, stock) {
      articuloParaEditar = { id, nombre, precio, stock };
      document.getElementById('editModal').classList.remove('hidden');
    }

    function cerrarModalEditar() {
      document.getElementById('editModal').classList.add('hidden');
      document.getElementById('editPassword').value = "";
      articuloParaEditar = null;
    }

    function confirmarEditar() {
      const password = document.getElementById('editPassword').value;
      if (!password) {
        mostrarNotificacion("Debe ingresar la contraseña.", 'warning');
        return;
      }
      if (password !== "6511") {
        mostrarNotificacion("Contraseña incorrecta.", 'error');
        return;
      }
      if (articuloParaEditar) {
        document.getElementById('nombre').value = articuloParaEditar.nombre;
        document.getElementById('precio').value = articuloParaEditar.precio;
        document.getElementById('stock').value = articuloParaEditar.stock;
        editandoId = articuloParaEditar.id;
        document.getElementById('guardarBtn').textContent = "Actualizar";
        document.getElementById('crear-articulo').scrollIntoView({ behavior: 'smooth' });
        cerrarModalEditar();
      }
    }

    async function guardarArticulo() {
      const nombre = document.getElementById('nombre').value.trim();
      const precio = parseFloat(document.getElementById('precio').value);
      const stock = parseInt(document.getElementById('stock').value) || 0;

      if (!nombre || isNaN(precio) || precio < 0) {
        mostrarNotificacion("Ingrese un nombre válido y un precio positivo.", 'error');
        return;
      }
      if (stock < 0) {
        mostrarNotificacion("La cantidad no puede ser negativa.", 'error');
        return;
      }

      const loading = document.getElementById('loading');
      loading.classList.remove('hidden');
      document.getElementById('guardarBtn').disabled = true;

      try {
        if (editandoId === null) {
          const { error } = await supabaseClient.from('articulos').insert([{ nombre, precio, stock }]);
          if (error) throw error;
          mostrarNotificacion("Artículo guardado exitosamente.");
        } else {
          const { error } = await supabaseClient.from('articulos').update({ nombre, precio, stock }).eq('id', editandoId);
          if (error) throw error;
          mostrarNotificacion("Artículo actualizado exitosamente.");
          editandoId = null;
          document.getElementById('guardarBtn').textContent = "Guardar";
        }
        document.getElementById('nombre').value = "";
        document.getElementById('precio').value = "";
        document.getElementById('stock').value = "";
        cargarArticulos();
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      } finally {
        loading.classList.add('hidden');
        document.getElementById('guardarBtn').disabled = false;
      }
    }

    function getStockClass(stock) {
      if (stock <= 0) return 'text-red-600 bg-red-100';
      if (stock <= 10) return 'text-yellow-600 bg-yellow-100';
      return 'text-green-600 bg-green-100';
    }

    async function cargarArticulos() {
      try {
        const { data, error } = await supabaseClient.from('articulos').select('*').order('id', { ascending: false });
        if (error) throw error;

        const listaDesktop = document.getElementById('listaDesktop');
        const listaMobile = document.getElementById('listaMobile');
        const noData = document.getElementById('noData');

        listaDesktop.innerHTML = "";
        listaMobile.innerHTML = "";

        if (data.length === 0) {
          noData.classList.remove('hidden');
        } else {
          noData.classList.add('hidden');
          data.forEach(articulo => {
            const stock = articulo.stock || 0;
            const stockClass = getStockClass(stock);

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="px-4 py-2 text-sm">${articulo.nombre}</td>
              <td class="px-4 py-2 text-sm">${parseFloat(articulo.precio).toFixed(2)}</td>
              <td class="px-4 py-2 text-center">
                <span class="px-2 py-1 rounded-full text-sm font-medium ${stockClass}">${stock}</span>
              </td>
              <td class="px-4 py-2 text-center space-x-1">
                <button onclick="mostrarModalStock(${articulo.id}, '${articulo.nombre.replace(/'/g, "\\'")}', ${articulo.precio}, ${stock})"
                 class="bg-blue-400 hover:bg-blue-500 px-2 py-1 rounded text-white text-xs transition focus:outline-none focus:ring-2 focus:ring-blue-600" aria-label="Agregar stock a ${articulo.nombre}">+Stock</button>
                <button onclick="editarArticulo(${articulo.id}, '${articulo.nombre.replace(/'/g, "\\'")}', ${articulo.precio}, ${stock})"
                  class="bg-yellow-300 hover:bg-yellow-400 px-2 py-1 rounded text-xs transition focus:outline-none focus:ring-2 focus:ring-yellow-600" aria-label="Editar ${articulo.nombre}">Editar</button>
                <button onclick="mostrarModalEliminar(${articulo.id})"
                  class="bg-red-400 hover:bg-red-500 px-2 py-1 rounded text-white text-xs transition focus:outline-none focus:ring-2 focus:ring-red-600" aria-label="Eliminar ${articulo.nombre}">Eliminar</button>
              </td>
            `;
            listaDesktop.appendChild(tr);

            const card = document.createElement('div');
            card.className = "bg-yellow-50 p-3 rounded-lg shadow";
            card.innerHTML = `
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h4 class="font-semibold text-gray-800">${articulo.nombre}</h4>
                  <p class="text-sm text-gray-600">RD$ ${parseFloat(articulo.precio).toFixed(2)}</p>
                </div>
                <span class="px-2 py-1 rounded-full text-sm font-medium ${stockClass}">${stock} disp.</span>
              </div>
              <div class="flex gap-2 mt-2">
                <button onclick="mostrarModalStock(${articulo.id}, '${articulo.nombre.replace(/'/g, "\\'")}', ${stock})"
                  class="flex-1 bg-blue-400 hover:bg-blue-500 px-2 py-1.5 rounded text-white text-xs transition">+Stock</button>
                <button onclick="editarArticulo(${articulo.id}, '${articulo.nombre.replace(/'/g, "\\'")}', ${articulo.precio}, ${stock})"
                  class="flex-1 bg-yellow-300 hover:bg-yellow-400 px-2 py-1.5 rounded text-xs transition">Editar</button>
                <button onclick="mostrarModalEliminar(${articulo.id})"
                  class="flex-1 bg-red-400 hover:bg-red-500 px-2 py-1.5 rounded text-white text-xs transition">Eliminar</button>
              </div>
            `;
            listaMobile.appendChild(card);
          });
        }
      } catch (error) {
        mostrarNotificacion("Error al cargar artículos: " + error.message, 'error');
      }
    }

    function mostrarModalEliminar(id) {
      articuloAEliminar = id;
      document.getElementById('confirmModal').classList.remove('hidden');
    }

    function cerrarModal() {
      document.getElementById('confirmModal').classList.add('hidden');
      articuloAEliminar = null;
      document.getElementById('deletePassword').value = "";
    }

    async function confirmarEliminar() {
      const password = document.getElementById('deletePassword').value;
      if (!password) {
        mostrarNotificacion("Debe ingresar la contraseña.", 'warning');
        return;
      }
      if (password !== "6511") {
        mostrarNotificacion("Contraseña incorrecta.", 'error');
        return;
      }
      if (!articuloAEliminar) return;
      try {
        const { error } = await supabaseClient.from('articulos').delete().eq('id', articuloAEliminar);
        if (error) throw error;
        mostrarNotificacion("Artículo eliminado exitosamente.");
        cargarArticulos();
      } catch (error) {
        mostrarNotificacion("Error al eliminar: " + error.message, 'error');
      } finally {
        cerrarModal();
      }
    }

    function mostrarModalStock(id, nombre, stockActual) {
      articuloParaStock = { id, nombre, stock: stockActual };
      document.getElementById('stockArticuloNombre').textContent = nombre;
      document.getElementById('stockActual').textContent = stockActual;
      document.getElementById('cantidadAgregar').value = "";
      document.getElementById('stockPassword').value = "";
      document.getElementById('stockModal').classList.remove('hidden');
    }

    function cerrarModalStock() {
      document.getElementById('stockModal').classList.add('hidden');
      articuloParaStock = null;
    }

    async function confirmarAgregarStock() {
      if (!articuloParaStock) return;
      const cantidad = parseInt(document.getElementById('cantidadAgregar').value);
      const password = document.getElementById('stockPassword').value;

      if (!cantidad || cantidad <= 0) {
        mostrarNotificacion("Ingrese una cantidad válida.", 'warning');
        return;
      }
      if (!password) {
        mostrarNotificacion("Debe ingresar la contraseña.", 'warning');
        return;
      }
      if (password !== "6511") {
        mostrarNotificacion("Contraseña incorrecta.", 'error');
        return;
      }

      try {
        const nuevoStock = articuloParaStock.stock + cantidad;
        const { error } = await supabaseClient
          .from('articulos')
          .update({ stock: nuevoStock })
          .eq('id', articuloParaStock.id);

        if (error) throw error;
        mostrarNotificacion(`Se agregaron ${cantidad} unidades a ${articuloParaStock.nombre}.`);
        cargarArticulos();
        cerrarModalStock();
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      }
    }

    // Cargar artículos al inicio
    cargarArticulos();
  </script>

</body>
</html>
