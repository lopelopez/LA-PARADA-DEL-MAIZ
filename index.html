<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>La Parada del Maíz y El Majarete de Leidy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Optional: Add a loading library like Toastify for better notifications -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="bg-yellow-50 font-sans">

  <!-- Banner moderno con overlay -->
  <div class="relative w-full h-36 md:h-48 lg:h-56">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo de La Parada del Maíz" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center">
      <h1 class="text-white text-xl md:text-3xl lg:text-4xl font-bold text-center drop-shadow-lg">
        La Parada del Maíz y El Majarete de Leidy
      </h1>
    </div>
  </div>

  <!-- Navegación -->
  <nav class="flex justify-center mt-4 space-x-4" role="navigation" aria-label="Navegación principal">
    <a href="facturacion.html" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded shadow transition focus:outline-none focus:ring-2 focus:ring-yellow-600">Ir a Facturación</a>
    <a href="historial.html" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded shadow transition focus:outline-none focus:ring-2 focus:ring-yellow-600">Ver Historial</a>
  </nav>

  <!-- Crear Artículo -->
  <section class="max-w-4xl mx-auto mt-8 bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow" role="region" aria-labelledby="crear-articulo">
    <h2 id="crear-articulo" class="text-2xl font-semibold mb-4 text-gray-700">Crear Artículo</h2>

    <div class="flex flex-col md:flex-row gap-4 mb-4">
      <input type="text" id="nombre" placeholder="Nombre del artículo" maxlength="100"
             class="border border-gray-300 p-2 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-yellow-400" aria-label="Nombre del artículo">
      <input type="number" id="precio" placeholder="Precio (RD$)" min="0" step="0.01"
             class="border border-gray-300 p-2 rounded-lg w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-yellow-400" aria-label="Precio del artículo">
    </div>
    <button id="guardarBtn" onclick="guardarArticulo()"
            class="bg-yellow-400 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg shadow-md transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-600">
      Guardar
    </button>
    <div id="loading" class="hidden mt-2 text-yellow-600">Guardando...</div>
  </section>

  <!-- Lista de Artículos -->
  <section class="max-w-4xl mx-auto mt-8 bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow" role="region" aria-labelledby="lista-articulos">
    <h3 id="lista-articulos" class="text-xl font-semibold mb-4 text-gray-700">Lista de Artículos</h3>

    <table class="min-w-full border border-gray-200 divide-y divide-gray-200" role="table" aria-label="Lista de artículos">
      <thead class="bg-yellow-100">
        <tr>
          <th class="px-4 py-2 text-left text-gray-700" scope="col">Nombre</th>
          <th class="px-4 py-2 text-left text-gray-700" scope="col">Precio (RD$)</th>
          <th class="px-4 py-2 text-center text-gray-700" scope="col">Acciones</th>
        </tr>
      </thead>
      <tbody id="lista" class="divide-y divide-gray-100" role="rowgroup"></tbody>
    </table>
    <div id="noData" class="text-center text-gray-500 mt-4 hidden">No hay artículos registrados.</div>
  </section>

  <!-- Modal de confirmación para eliminar (simple) -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
      <h3 id="confirmTitle" class="text-lg font-semibold mb-4">Confirmar Eliminación</h3>
      <p>¿Estás seguro de que deseas eliminar este artículo?</p>
      <div class="flex justify-end mt-4 space-x-2">
        <button onclick="cerrarModal()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button id="confirmDelete" onclick="confirmarEliminar()" class="px-4 py-2 bg-red-500 text-white rounded">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- JS de Supabase y funciones -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let editandoId = null;
    let articuloAEliminar = null;
    // Nota: Mueve esta clave a un archivo de configuración seguro o variable de entorno
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb"; // Reemplaza con tu clave real de forma segura
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#ffc107",
      }).showToast();
    }

    function editarArticulo(id, nombre, precio) {
      document.getElementById('nombre').value = nombre;
      document.getElementById('precio').value = precio;
      editandoId = id;
      document.getElementById('guardarBtn').textContent = "Actualizar";
    }

    async function guardarArticulo() {
      const nombre = document.getElementById('nombre').value.trim();
      const precio = parseFloat(document.getElementById('precio').value);
      if (!nombre || isNaN(precio) || precio < 0) {
        mostrarNotificacion("Ingrese un nombre válido y un precio positivo.", 'error');
        return;
      }

      const loading = document.getElementById('loading');
      loading.classList.remove('hidden');
      document.getElementById('guardarBtn').disabled = true;

      try {
        if (editandoId === null) {
          const { error } = await supabaseClient.from('articulos').insert([{ nombre, precio }]);
          if (error) throw error;
          mostrarNotificacion("Artículo guardado exitosamente.");
        } else {
          const { error } = await supabaseClient.from('articulos').update({ nombre, precio }).eq('id', editandoId);
          if (error) throw error;
          mostrarNotificacion("Artículo actualizado exitosamente.");
          editandoId = null;
          document.getElementById('guardarBtn').textContent = "Guardar";
        }
        document.getElementById('nombre').value = "";
        document.getElementById('precio').value = "";
        cargarArticulos();
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      } finally {
        loading.classList.add('hidden');
        document.getElementById('guardarBtn').disabled = false;
      }
    }

    async function cargarArticulos() {
      try {
        const { data, error } = await supabaseClient.from('articulos').select('*').order('id', { ascending: false });
        if (error) throw error;
        const lista = document.getElementById('lista');
        const noData = document.getElementById('noData');
        lista.innerHTML = "";
        if (data.length === 0) {
          noData.classList.remove('hidden');
        } else {
          noData.classList.add('hidden');
          data.forEach(articulo => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="px-4 py-2">${articulo.nombre}</td>
              <td class="px-4 py-2">${articulo.precio.toFixed(2)}</td>
              <td class="px-4 py-2 text-center space-x-2">
                <button onclick="editarArticulo(${articulo.id}, '${articulo.nombre.replace(/'/g, "\\'")}', ${articulo.precio})"
                class="bg-yellow-300 hover:bg-yellow-400 px-2 py-1 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-yellow-600" aria-label="Editar ${articulo.nombre}">Editar</button>
                <button onclick="mostrarModalEliminar(${articulo.id})"
                class="bg-red-400 hover:bg-red-500 px-2 py-1 rounded-lg text-white transition focus:outline-none focus:ring-2 focus:ring-red-600" aria-label="Eliminar ${articulo.nombre}">Eliminar</button>
              </td>
            `;
            lista.appendChild(tr);
          });
        }
      } catch (error) {
        mostrarNotificacion("Error al cargar artículos: " + error.message, 'error');
      }
    }

    function mostrarModalEliminar(id) {
      articuloAEliminar = id;
      document.getElementById('confirmModal').classList.remove('hidden');
    }

    function cerrarModal() {
      document.getElementById('confirmModal').classList.add('hidden');
      articuloAEliminar = null;
    }

    async function confirmarEliminar() {
      if (!articuloAEliminar) return;
      try {
        const { error } = await supabaseClient.from('articulos').delete().eq('id', articuloAEliminar);
        if (error) throw error;
        mostrarNotificacion("Artículo eliminado exitosamente.");
        cargarArticulos();
      } catch (error) {
        mostrarNotificacion("Error al eliminar: " + error.message, 'error');
      } finally {
        cerrarModal();
      }
    }

    // Cargar artículos al inicio
    cargarArticulos();
  </script>

</body>
</html>