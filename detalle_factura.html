<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalle de Factura - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center">La Parada del Maíz</h1>
    </div>
  </div>

  <nav class="flex flex-wrap justify-center gap-2 mt-4 px-2">
    <a href="historial.html" class="bg-yellow-400 text-white px-4 py-2 rounded shadow text-sm">Volver al Historial</a>
  </nav>

  <section class="max-w-4xl mx-auto mt-6 bg-white p-4 rounded-xl shadow mx-2">
    <h2 class="text-2xl font-semibold mb-2 text-center">Detalle de Factura</h2>

    <div id="infoFactura" class="bg-yellow-50 p-3 rounded-lg mb-4 text-center">
      <p class="text-gray-600">
        <span class="font-semibold">Factura #<span id="facturaNum">--</span></span> |
        <span>Fecha: <span id="facturaFecha">--</span></span>
      </p>
    </div>

    <!-- USUARIO -->
    <div id="usuarioBox" class="bg-purple-50 p-3 rounded-lg mb-4 hidden">
      <p class="text-sm text-gray-700">
        <span class="font-semibold">Usuario:</span> 
        <span id="usuarioTexto" class="font-bold text-purple-600"></span>
      </p>
    </div>

    <!-- COMENTARIO -->
    <div id="comentarioBox" class="bg-blue-50 p-3 rounded-lg mb-4 hidden">
      <p class="text-sm text-gray-700">
        <span class="font-semibold">Comentario:</span> 
        <span id="comentarioTexto"></span>
      </p>
    </div>

    <ul id="detalleFactura" class="space-y-2"></ul>
    <div id="noData" class="text-center text-gray-500 mt-4 hidden">No se encontraron detalles</div>

    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
      <div class="flex justify-between mb-2">
        <span class="text-gray-600">Subtotal:</span>
        <span class="font-medium">RD$ <span id="subtotalFactura">0.00</span></span>
      </div>
      <div id="descuentoRow" class="flex justify-between mb-2 hidden">
        <span class="text-red-600">Descuento:</span>
        <span class="text-red-600">- RD$ <span id="descuentoFactura">0.00</span></span>
      </div>
      <hr class="my-2">
      <div class="flex justify-between">
        <span class="font-semibold">Total:</span>
        <span class="font-bold text-green-600 text-xl">RD$ <span id="totalFactura">0.00</span></span>
      </div>
    </div>

    <div id="loading" class="hidden mt-4 text-yellow-600 text-center">Cargando...</div>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    const params = new URLSearchParams(window.location.search);
    const facturaId = params.get("id");

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function formatearFecha(fechaStr) {
      if (!fechaStr) return '--';
      return fechaStr.split('T')[0].split('-').reverse().join('/');
    }

    async function cargarDetalle() {
      if (!facturaId) {
        mostrarNotificacion("ID de factura no válido", 'error');
        return;
      }

      document.getElementById('loading').classList.remove('hidden');

      try {
        // SELECCIONAMOS EL CAMPO 'USUARIO' JUNTO CON LOS DEMÁS
        const { data: facturaData, error: facturaError } = await supabaseClient
          .from('facturas')
          .select('id, fecha, subtotal, descuento, total, comentario, usuario')
          .eq('id', facturaId)
          .single();

        if (facturaError) throw facturaError;

        document.getElementById('facturaNum').textContent = facturaData.id;
        document.getElementById('facturaFecha').textContent = formatearFecha(facturaData.fecha);

        // MOSTRAR USUARIO SI EXISTE
        if (facturaData.usuario && facturaData.usuario.trim() !== "") {
          document.getElementById('usuarioBox').classList.remove('hidden');
          document.getElementById('usuarioTexto').textContent = facturaData.usuario;
        }

        // MOSTRAR COMENTARIO SI EXISTE
        if (facturaData.comentario && facturaData.comentario.trim() !== "") {
          document.getElementById('comentarioBox').classList.remove('hidden');
          document.getElementById('comentarioTexto').textContent = facturaData.comentario;
        }

        const { data, error } = await supabaseClient
          .from('detalle_factura')
          .select('cantidad, precio, subtotal, articulos(nombre)')
          .eq('factura_id', facturaId);

        if (error) throw error;

        const lista = document.getElementById('detalleFactura');
        const noData = document.getElementById('noData');
        lista.innerHTML = "";

        if (data.length === 0) {
          noData.classList.remove('hidden');
        } else {
          noData.classList.add('hidden');
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = "flex justify-between bg-yellow-100 p-3 rounded-lg";
            li.innerHTML = `
              <span class="font-semibold">${item.articulos.nombre}</span>
              <span class="text-gray-600">
                Cant: ${item.cantidad} | Precio: RD$${parseFloat(item.precio).toFixed(2)} | 
                <span class="font-medium">RD$${parseFloat(item.subtotal).toFixed(2)}</span>
              </span>`;
            lista.appendChild(li);
          });
        }

        document.getElementById('subtotalFactura').textContent = parseFloat(facturaData.subtotal).toFixed(2);

        const descuento = parseFloat(facturaData.descuento) || 0;
        if (descuento > 0) {
          document.getElementById('descuentoRow').classList.remove('hidden');
          document.getElementById('descuentoFactura').textContent = descuento.toFixed(2);
        }

        document.getElementById('totalFactura').textContent = parseFloat(facturaData.total).toFixed(2);

      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }
setInterval(async () => {
  const usuario = localStorage.getItem('usuario');
  if (usuario) {
    const usuarioObj = JSON.parse(usuario);
    try {
      await supabaseClient
        .from('usuarios')
        .update({ ultima_conexion: new Date().toISOString() })
        .eq('username', usuarioObj.username);
    } catch (e) {
      console.error('Error actualizando conexión:', e);
    }
  }
}, 30000);
    window.onload = cargarDetalle;
    
  </script>
</body>
</html>
