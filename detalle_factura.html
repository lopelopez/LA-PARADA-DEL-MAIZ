<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facturación - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @media (max-width: 640px) {
      .nav-btn { font-size: 0.75rem; padding: 0.5rem 0.75rem; }
    }
  </style>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36 md:h-48 lg:h-56">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo de La Parada del Maíz" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center px-2">
      <h1 class="text-white text-lg sm:text-xl md:text-3xl lg:text-4xl font-bold text-center drop-shadow-lg">
        La Parada del Maíz y El Majarete de Leidy
      </h1>
    </div>
  </div>

  <!-- Navegación -->
  <nav class="flex flex-wrap justify-center gap-2 sm:gap-3 mt-4 px-2">
    <a href="index.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded shadow text-sm sm:text-base">Volver a Artículos</a>
    <a href="historial.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded shadow text-sm sm:text-base">Ver Historial</a>
    <a href="cajachica.html" class="nav-btn bg-red-400 hover:bg-red-500 text-white px-3 sm:px-4 py-2 rounded shadow text-sm sm:text-base">Caja Chica</a>
  </nav>

  <!-- Crear Factura -->
  <section class="max-w-4xl mx-auto mt-6 sm:mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-md mx-2 sm:mx-4 lg:mx-auto">
    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">Crear Factura</h2>

    <div class="flex flex-col gap-3 sm:gap-4 mb-4">
      <div>
        <select id="articuloSelect" onchange="mostrarStockDisponible()" class="border border-gray-300 p-2 rounded-lg w-full text-sm sm:text-base">
          <option value="">Selecciona un artículo</option>
        </select>
        <p id="stockInfo" class="text-sm text-gray-500 mt-1 hidden">
          Disponible: <span id="stockDisponible" class="font-medium">0</span> unidades
        </p>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
        <input type="number" id="cantidad" placeholder="Cantidad" min="1" max="1000"
               class="border border-gray-300 p-2 rounded-lg w-full sm:w-1/2 text-sm sm:text-base">
        <div class="w-full sm:w-1/2">
          <label class="block mb-1 font-medium text-gray-700 text-sm">Fecha de Factura:</label>
          <input type="date" id="fechaFactura" class="border border-gray-300 p-2 rounded-lg w-full text-sm sm:text-base">
        </div>
      </div>
    </div>

    <button onclick="agregarItem()" class="w-full sm:w-auto bg-yellow-400 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg shadow text-sm sm:text-base">
      Agregar
    </button>

    <h3 class="mt-6 text-lg sm:text-xl font-semibold text-gray-700">Detalle de Factura</h3>
    <ul id="detalleLista" class="space-y-2 mt-2"></ul>

    <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
      <label class="font-medium text-gray-700 text-sm sm:text-base">Descuento (RD$):</label>
      <input type="number" id="descuento" value="0" min="0" step="0.01" oninput="actualizarVistaFactura()"
             class="border border-gray-300 p-2 rounded-lg w-full sm:w-32 text-sm sm:text-base">
    </div>

    <!-- COMENTARIO -->
    <div class="mb-4 mt-4">
      <label class="block text-sm font-medium text-gray-700 mb-1">Comentario (opcional)</label>
      <input type="text" id="comentario" placeholder="Agregar un comentario..." 
        class="w-full border border-gray-300 p-2 rounded-lg text-sm sm:text-base">
    </div>

    <h3 class="mt-4 text-lg sm:text-xl font-semibold text-gray-700">Total: RD$ <span id="totalFactura">0.00</span></h3>

    <button onclick="mostrarModalGuardar()" id="guardarBtn"
            class="mt-4 w-full sm:w-auto bg-green-400 hover:bg-green-500 text-white px-6 py-2 rounded-lg shadow text-sm sm:text-base">
      Guardar Factura
    </button>
    <div id="loading" class="hidden mt-2 text-green-600 text-sm">Guardando...</div>
  </section>

  <!-- Modal de confirmación para guardar -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-sm">
      <h3 class="text-base sm:text-lg font-semibold mb-4">Confirmar Guardado</h3>
      <p class="text-sm sm:text-base">¿Estás seguro de que deseas guardar esta factura? Se descontará del inventario.</p>
      <div class="flex justify-end mt-4 gap-2">
        <button onclick="cerrarModal()" class="px-3 sm:px-4 py-2 bg-gray-300 rounded text-sm sm:text-base">Cancelar</button>
        <button onclick="confirmarGuardar()" class="px-3 sm:px-4 py-2 bg-green-500 text-white rounded text-sm sm:text-base">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let itemsFactura = [];
    let articulosData = [];

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : tipo === 'warning' ? "#ffc107" : "#28a745"
      }).showToast();
    }

    function obtenerFechaHoyLocal() {
      const hoy = new Date();
      return `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
    }

    async function cargarArticulos() {
      try {
        const { data, error } = await supabaseClient.from('articulos').select('*');
        if (error) throw error;
        articulosData = data;
        const select = document.getElementById('articuloSelect');
        select.innerHTML = '<option value="">Selecciona un artículo</option>';
        data.forEach(articulo => {
          const option = document.createElement('option');
          option.value = articulo.id;
          option.textContent = `${articulo.nombre} - RD$${parseFloat(articulo.precio).toFixed(2)} (${articulo.stock || 0} disp.)`;
          option.dataset.precio = articulo.precio;
          option.dataset.stock = articulo.stock || 0;
          option.dataset.nombre = articulo.nombre;
          if ((articulo.stock || 0) <= 0) option.style.color = '#dc3545';
          select.appendChild(option);
        });
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      }
    }

    function mostrarStockDisponible() {
      const select = document.getElementById('articuloSelect');
      const stockInfo = document.getElementById('stockInfo');
      const stockDisponible = document.getElementById('stockDisponible');
      if (select.value) {
        const stock = parseInt(select.options[select.selectedIndex].dataset.stock);
        const enFactura = itemsFactura.find(item => item.articulo_id == select.value);
        const cantidadEnFactura = enFactura ? enFactura.cantidad : 0;
        const disponibleReal = stock - cantidadEnFactura;
        stockDisponible.textContent = disponibleReal;
        stockInfo.classList.remove('hidden');
        stockDisponible.className = 'font-medium ' + (disponibleReal <= 0 ? 'text-red-600' : disponibleReal <= 10 ? 'text-yellow-600' : 'text-green-600');
      } else { stockInfo.classList.add('hidden'); }
    }

    function agregarItem() {
      const select = document.getElementById('articuloSelect');
      const cantidad = parseInt(document.getElementById('cantidad').value);
      if (!select.value) return mostrarNotificacion("Selecciona un artículo.", 'warning');
      if (!cantidad || cantidad <= 0) return mostrarNotificacion("Cantidad inválida.", 'warning');

      const articuloId = select.value;
      const nombre = select.options[select.selectedIndex].dataset.nombre;
      const precio = parseFloat(select.options[select.selectedIndex].dataset.precio);
      const stockDisponible = parseInt(select.options[select.selectedIndex].dataset.stock);

      const existe = itemsFactura.find(item => item.articulo_id == articuloId);
      const cantidadYaEnFactura = existe ? existe.cantidad : 0;
      if (cantidad + cantidadYaEnFactura > stockDisponible) return mostrarNotificacion(`Stock insuficiente. Solo hay ${stockDisponible - cantidadYaEnFactura}.`, 'error');

      if (existe) { existe.cantidad += cantidad; existe.subtotal = existe.precio * existe.cantidad; }
      else { itemsFactura.push({ articulo_id: articuloId, nombre, cantidad, precio, subtotal: precio * cantidad }); }

      actualizarVistaFactura();
      document.getElementById('cantidad').value = "";
      mostrarStockDisponible();
    }

    function actualizarVistaFactura() {
      const lista = document.getElementById('detalleLista');
      lista.innerHTML = "";
      let subtotalGeneral = 0;
      itemsFactura.forEach((item, index) => {
        subtotalGeneral += item.subtotal;
        const li = document.createElement('li');
        li.className = "bg-yellow-100 p-2 rounded-lg shadow flex justify-between gap-2";
        li.innerHTML = `<span class="text-sm sm:text-base">${item.nombre} | Cant: ${item.cantidad} | RD$${item.subtotal.toFixed(2)}</span>
          <button onclick="eliminarItem(${index})" class="bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded text-sm">X</button>`;
        lista.appendChild(li);
      });
      const descuento = parseFloat(document.getElementById('descuento').value) || 0;
      document.getElementById('totalFactura').textContent = (subtotalGeneral - descuento).toFixed(2);
    }

    function eliminarItem(index) { itemsFactura.splice(index, 1); actualizarVistaFactura(); mostrarStockDisponible(); }
    function mostrarModalGuardar() { if (itemsFactura.length === 0) return mostrarNotificacion("Agrega algo", 'warning'); document.getElementById('confirmModal').classList.remove('hidden'); }
    function cerrarModal() { document.getElementById('confirmModal').classList.add('hidden'); }

    async function confirmarGuardar() {
      cerrarModal();
      document.getElementById('loading').classList.remove('hidden');
      try {
        let subtotal = 0;
        itemsFactura.forEach(item => subtotal += item.subtotal);
        const descuento = parseFloat(document.getElementById('descuento').value) || 0;
        const total = subtotal - descuento;
        const comentario = document.getElementById('comentario').value.trim();
        const fechaInput = document.getElementById('fechaFactura').value;
        if (!fechaInput) throw new Error("Selecciona fecha");

        // GUARDAR FACTURA CON COMENTARIO
        const { data: facturaData, error: facturaError } = await supabaseClient
          .from('facturas')
          .insert([{ fecha: fechaInput + 'T12:00:00', subtotal, descuento, total, comentario }])
          .select();
        if (facturaError) throw facturaError;

        const facturaId = facturaData[0].id;
        const detalles = itemsFactura.map(item => ({ factura_id: facturaId, articulo_id: item.articulo_id, cantidad: item.cantidad, precio: item.precio, subtotal: item.subtotal }));
        await supabaseClient.from('detalle_factura').insert(detalles);

        for (const item of itemsFactura) {
          const articulo = articulosData.find(a => a.id == item.articulo_id);
          if (articulo) await supabaseClient.from('articulos').update({ stock: Math.max(0, (articulo.stock || 0) - item.cantidad) }).eq('id', item.articulo_id);
        }

        mostrarNotificacion("Factura guardada correctamente");
        itemsFactura = []; actualizarVistaFactura();
        document.getElementById('descuento').value = "0";
        document.getElementById('comentario').value = "";
        document.getElementById('stockInfo').classList.add('hidden');
        await cargarArticulos();
      } catch (error) { mostrarNotificacion("Error: " + error.message, 'error'); }
      finally { document.getElementById('loading').classList.add('hidden'); }
    }

    window.onload = () => { cargarArticulos(); document.getElementById('fechaFactura').value = obtenerFechaHoyLocal(); };
  </script>
</body>
</html>
