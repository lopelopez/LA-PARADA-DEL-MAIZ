<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caja Chica - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center">Caja Chica</h1>
    </div>
  </div>

  <nav class="flex flex-wrap justify-center gap-2 mt-4 px-2">
    <a href="index.html" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Artículos</a>
    <button onclick="imprimirCajaChica()" class="bg-green-400 hover:bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">Imprimir</button>
  </nav>

  <section class="max-w-4xl mx-auto mt-6 bg-white p-4 rounded-xl shadow mx-2">
    <h2 class="text-2xl font-semibold mb-4 text-center">Caja del Día</h2>
    
    <!-- Apertura de caja -->
    <div class="bg-yellow-100 p-4 rounded-lg mb-4" id="panelApertura">
      <h3 class="font-semibold mb-2">Abrir Caja</h3>
      <div class="flex flex-col sm:flex-row gap-2">
        <input type="number" id="montoInicial" placeholder="Monto inicial" class="border p-2 rounded w-full sm:w-1/2" step="0.01">
        <input type="date" id="fechaCaja" class="border p-2 rounded w-full sm:w-1/2">
        <button onclick="abrirCaja()" class="bg-green-400 hover:bg-green-500 text-white px-4 py-2 rounded w-full sm:w-auto">Abrir Caja</button>
      </div>
    </div>

    <!-- Panel de caja abierta -->
    <div id="panelCajaAbierta" class="hidden">
      <!-- Agregar gasto -->
      <div class="bg-red-50 p-4 rounded-lg mb-4">
        <h3 class="font-semibold mb-2">Registrar Gasto</h3>
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" id="descripcionGasto" placeholder="Descripción del gasto" class="border p-2 rounded w-full">
          <input type="number" id="montoGasto" placeholder="Monto" class="border p-2 rounded w-full sm:w-32" step="0.01">
          <button onclick="agregarGasto()" class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded w-full sm:w-auto">Agregar Gasto</button>
        </div>
      </div>

      <!-- Estado actual -->
      <div class="bg-gray-100 p-4 rounded-lg mb-4">
        <h3 class="font-semibold mb-2">Estado de Caja</h3>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>Monto Inicial: <span id="montoInicialMostrar" class="font-bold">RD$0.00</span></div>
          <div>Total Gastos: <span id="totalGastosMostrar" class="font-bold text-red-600">RD$0.00</span></div>
          <div class="col-span-2">Monto Final: <span id="montoFinalMostrar" class="font-bold text-green-600">RD$0.00</span></div>
        </div>
      </div>

      <!-- Lista de gastos -->
      <h3 class="font-semibold mb-2">Gastos del Día</h3>
      <ul id="listaGastos" class="space-y-2 mb-4"></ul>
      <div id="noGastos" class="text-center text-gray-500 mt-4 hidden">No hay gastos registrados</div>

      <!-- Cerrar caja -->
      <button onclick="cerrarCaja()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded w-full">Cerrar Caja</button>
    </div>

    <!-- Historial de cajas cerradas -->
    <h3 class="text-xl font-semibold mt-8 mb-4">Historial de Cajas</h3>
    <ul id="historialCajas" class="space-y-2"></ul>
    <div id="noHistorial" class="text-center text-gray-500 mt-4 hidden">No hay cajas registradas</div>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let cajaActual = null;
    let gastos = [];

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function obtenerFechaHoyLocal() {
      const h = new Date();
      return `${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}-${String(h.getDate()).padStart(2,'0')}`;
    }

    async function abrirCaja() {
      const monto = parseFloat(document.getElementById('montoInicial').value);
      const fecha = document.getElementById('fechaCaja').value;
      
      if (!monto || monto <= 0) return mostrarNotificacion('Ingrese monto inicial', 'warning');
      if (!fecha) return mostrarNotificacion('Seleccione fecha', 'warning');

      try {
        const { data, error } = await supabaseClient
          .from('caja_chica')
          .insert([{ fecha, monto_inicial: monto, monto_gastos: 0, monto_final: monto }])
          .select()
          .single();

        if (error) throw error;
        cajaActual = data;
        gastos = [];
        actualizarVistaCaja();
        await cargarHistorial();
        mostrarNotificacion('Caja abierta correctamente');
      } catch (e) { mostrarNotificacion('Error: ' + e.message, 'error'); }
    }

    async function agregarGasto() {
      if (!cajaActual) return mostrarNotificacion('Abra una caja primero', 'warning');
      
      const descripcion = document.getElementById('descripcionGasto').value.trim();
      const monto = parseFloat(document.getElementById('montoGasto').value);

      if (!descripcion) return mostrarNotificacion('Ingrese descripción', 'warning');
      if (!monto || monto <= 0) return mostrarNotificacion('Ingrese monto válido', 'warning');

      try {
        await supabaseClient
          .from('gastos')
          .insert([{ caja_chica_id: cajaActual.id, descripcion, monto, fecha: new Date().toISOString() }]);

        const nuevoGasto = cajaActual.monto_gastos + monto;
        const nuevoFinal = cajaActual.monto_inicial - nuevoGasto;

        await supabaseClient
          .from('caja_chica')
          .update({ monto_gastos: nuevoGasto, monto_final: nuevoFinal })
          .eq('id', cajaActual.id);

        cajaActual.monto_gastos = nuevoGasto;
        cajaActual.monto_final = nuevoFinal;

        document.getElementById('descripcionGasto').value = '';
        document.getElementById('montoGasto').value = '';
        
        await cargarGastos();
        actualizarVistaCaja();
        mostrarNotificacion('Gasto registrado');
      } catch (e) { mostrarNotificacion('Error: ' + e.message, 'error'); }
    }

    async function cargarGastos() {
      if (!cajaActual) return;

      const { data } = await supabaseClient
        .from('gastos')
        .select('*')
        .eq('caja_chica_id', cajaActual.id)
        .order('id', { ascending: false });

      gastos = data || [];
    }

    function actualizarVistaCaja() {
      if (cajaActual) {
        document.getElementById('panelApertura').classList.add('hidden');
        document.getElementById('panelCajaAbierta').classList.remove('hidden');
        
        document.getElementById('montoInicialMostrar').textContent = `RD$${parseFloat(cajaActual.monto_inicial).toFixed(2)}`;
        document.getElementById('totalGastosMostrar').textContent = `RD$${parseFloat(cajaActual.monto_gastos).toFixed(2)}`;
        document.getElementById('montoFinalMostrar').textContent = `RD$${parseFloat(cajaActual.monto_final).toFixed(2)}`;

        const lista = document.getElementById('listaGastos');
        const noGastos = document.getElementById('noGastos');
        lista.innerHTML = '';

        if (gastos.length === 0) { noGastos.classList.remove('hidden'); }
        else {
          noGastos.classList.add('hidden');
          gastos.forEach(g => {
            const li = document.createElement('li');
            li.className = "bg-red-100 p-2 rounded flex justify-between";
            li.innerHTML = `<span>${g.descripcion}</span><span class="font-medium text-red-600">RD$${parseFloat(g.monto).toFixed(2)}</span>`;
            lista.appendChild(li);
          });
        }
      } else {
        document.getElementById('panelApertura').classList.remove('hidden');
        document.getElementById('panelCajaAbierta').classList.add('hidden');
      }
    }

    async function cerrarCaja() {
      if (!cajaActual) return mostrarNotificacion('No hay caja abierta', 'warning');
      
      if (confirm('¿Cerrar caja?')) {
        cajaActual = null;
        gastos = [];
        actualizarVistaCaja();
        await cargarHistorial();
        mostrarNotificacion('Caja cerrada');
      }
    }

    async function cargarHistorial() {
      const { data } = await supabaseClient
        .from('caja_chica')
        .select('*')
        .order('fecha', { ascending: false });

      const lista = document.getElementById('historialCajas');
      const noHistorial = document.getElementById('noHistorial');
      lista.innerHTML = '';

      if (!data || data.length === 0) { noHistorial.classList.remove('hidden'); return; }
      noHistorial.classList.add('hidden');

      data.forEach(caja => {
        const li = document.createElement('li');
        li.className = "bg-yellow-100 p-3 rounded-lg flex justify-between items-center";
        li.innerHTML = `
          <div>
            <span class="font-semibold">${caja.fecha}</span>
          </div>
          <div class="text-right text-sm">
            <div>Inicial: RD$${parseFloat(caja.monto_inicial).toFixed(2)}</div>
            <div class="text-red-600">Gastos: RD$${parseFloat(caja.monto_gastos).toFixed(2)}</div>
            <div class="font-bold text-green-600">Final: RD$${parseFloat(caja.monto_final).toFixed(2)}</div>
          </div>
        `;
        lista.appendChild(li);
      });
    }

    async function imprimirCajaChica() {
      const { data: cajas } = await supabaseClient
        .from('caja_chica')
        .select('*, gastos(*)')
        .order('fecha', { ascending: false })
        .limit(30);

      if (!cajas || cajas.length === 0) return mostrarNotificacion('No hay registros', 'warning');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      try { doc.addImage('LOGO LA PARADA DEL MAIZ.png', 'PNG', 10, 10, 30, 30); } catch(e) {}

      doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.setTextColor(255, 193, 7);
      doc.text("Caja Chica - La Parada del Maiz", 105, 20, { align: "center" });
      doc.setFontSize(12); doc.setTextColor(0, 0, 0);
      doc.text("Historial de Caja Chica", 105, 30, { align: "center" });
      doc.line(10, 35, 200, 35);

      let y = 45;
      let totalInicial = 0, totalGastos = 0, totalFinal = 0;

      cajas.forEach(caja => {
        doc.setFont("helvetica", "bold");
        doc.text(`Fecha: ${caja.fecha}`, 10, y); y += 6;
        
        doc.setFont("helvetica", "normal");
        doc.text(`Inicial: RD$${parseFloat(caja.monto_inicial).toFixed(2)} | Gastos: RD$${parseFloat(caja.monto_gastos).toFixed(2)} | Final: RD$${parseFloat(caja.monto_final).toFixed(2)}`, 10, y); y += 10;

        totalInicial += caja.monto_inicial;
        totalGastos += caja.monto_gastos;
        totalFinal += caja.monto_final;

        if (y > 270) { doc.addPage(); y = 20; }
      });

      y += 5;
      doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.setTextColor(255, 193, 7);
      doc.text(`Total Inicial: RD$${totalInicial.toFixed(2)}`, 105, y, { align: "center" }); y += 8;
      doc.text(`Total Gastos: RD$${totalGastos.toFixed(2)}`, 105, y, { align: "center" }); y += 8;
      doc.text(`Total Final: RD$${totalFinal.toFixed(2)}`, 105, y, { align: "center" });

      doc.save("Caja_Chica_Historial.pdf");
      mostrarNotificacion('PDF generado');
    }

    async function iniciar() {
      document.getElementById('fechaCaja').value = obtenerFechaHoyLocal();
      
      const hoy = obtenerFechaHoyLocal();
      const { data } = await supabaseClient
        .from('caja_chica')
        .select('*')
        .eq('fecha', hoy)
        .single();

      if (data) {
        cajaActual = data;
        await cargarGastos();
      }
      actualizarVistaCaja();
      await cargarHistorial();
    }
setInterval(async () => {
  const usuario = localStorage.getItem('usuario');
  if (usuario) {
    const usuarioObj = JSON.parse(usuario);
    try {
      await supabaseClient
        .from('usuarios')
        .update({ ultima_conexion: new Date().toISOString() })
        .eq('username', usuarioObj.username);
    } catch (e) {
      console.error('Error actualizando conexión:', e);
    }
  }
}, 30000);
    window.onload = iniciar;
    
  </script>
</body>
</html>
