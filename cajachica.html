<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caja Chica - La Parada del Ma√≠z</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* === DISE√ëO MODERNO === */
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fff7ed 100%);
      min-height: 100vh;
    }

    .banner {
      border-radius: 0 0 60px 60px;
      box-shadow: 0 15px 50px rgba(245, 158, 11, 0.3);
    }

    .nav-btn {
      border-radius: 16px;
      padding: 10px 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .nav-yellow {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .nav-yellow:hover {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .nav-green {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
    }

    .nav-green:hover {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .nav-red {
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
    }

    .nav-red:hover {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    .input-modern {
      border-radius: 16px;
      padding: 14px 18px;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      transition: all 0.3s ease;
    }

    .input-modern:focus {
      border-color: #f59e0b;
      background: white;
      box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.15);
      outline: none;
    }

    .btn-primary {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.45);
    }

    .btn-danger {
      border-radius: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #f87171, #ef4444);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
    }

    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.45);
    }

    .card-panel {
      background: linear-gradient(135deg, #ffffff, #fefbf4);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(245, 158, 11, 0.1);
      transition: all 0.3s ease;
    }

    .card-panel:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(245, 158, 11, 0.15);
    }

    .card-gasto {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      transition: all 0.3s ease;
    }

    .card-gasto:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.2);
    }

    .card-historial {
      background: linear-gradient(135deg, #ffffff, #fefbf4);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(245, 158, 11, 0.1);
      transition: all 0.3s ease;
    }

    .card-historial:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(245, 158, 11, 0.15);
    }

    .badge-info {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      padding: 10px 20px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
    }

    .badge-monto {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      padding: 12px 24px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      color: #065f46;
    }

    .badge-gasto {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      padding: 12px 24px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      color: #991b1b;
    }

    .badge-final {
      background: linear-gradient(135deg, #34d399, #10b981);
      padding: 16px 32px;
      border-radius: 20px;
      font-size: 24px;
      font-weight: 700;
      color: white;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35);
    }

    .section-title {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .info-box {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #f59e0b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 640px) {
      .glass-card {
        padding: 20px;
        border-radius: 22px;
      }
      
      .banner {
        border-radius: 0 0 45px 45px;
      }
    }
  </style>
</head>
<body>

  <!-- Banner -->
  <div class="relative w-full h-28 sm:h-36">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/50 to-yellow-600/60 flex items-center justify-center banner">
      <h1 class="text-white text-xl md:text-3xl font-bold text-center px-4 drop-shadow-lg">
        üí∞ Caja Chica
      </h1>
    </div>
  </div>

  <!-- Navegaci√≥n -->
  <nav class="flex flex-wrap justify-center gap-3 mt-6 px-4">
    <a href="index.html" class="nav-btn nav-yellow text-sm">üì¶ Art√≠culos</a>
    <button onclick="imprimirCajaChica()" class="nav-btn nav-green text-sm">üñ®Ô∏è Imprimir</button>
  </nav>

  <!-- Caja Chica -->
  <section class="max-w-4xl mx-auto mt-6 mx-4 mb-10">
    <div class="glass-card">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üí∞ Caja del D√≠a</h2>

      <!-- Loading -->
      <div id="loading" class="flex justify-center py-8">
        <div class="loading-spinner"></div>
      </div>

      <!-- Panel Apertura -->
      <div id="panelApertura" class="hidden">
        <div class="card-panel mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üìÇ Abrir Caja</h3>
          
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="w-full sm:w-1/3">
              <label class="block text-sm font-medium text-gray-700 mb-2">Monto Inicial:</label>
              <input type="number" id="montoInicial" placeholder="RD$ 0.00" 
                     class="input-modern w-full" step="0.01">
            </div>
            <div class="w-full sm:w-1/3">
              <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
              <input type="date" id="fechaCaja" class="input-modern w-full">
            </div>
            <div class="w-full sm:w-1/3">
              <label class="block text-sm font-medium text-gray-700 mb-2">¬†</label>
              <button onclick="abrirCaja()" class="btn-primary w-full">
                üìÇ Abrir Caja
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel Caja Abierta -->
      <div id="panelCajaAbierta" class="hidden">
        <!-- Registrar Gasto -->
        <div class="card-gasto mb-6">
          <h3 class="text-lg font-bold text-red-800 mb-4">üí∏ Registrar Gasto</h3>
          
          <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
              <input type="text" id="descripcionGasto" placeholder="Descripci√≥n del gasto" 
                     class="input-modern w-full">
            </div>
            <div class="w-full sm:w-40">
              <input type="number" id="montoGasto" placeholder="RD$ 0.00" 
                     class="input-modern w-full" step="0.01">
            </div>
            <button onclick="agregarGasto()" class="btn-danger w-full sm:w-auto">
              ‚ûï Agregar
            </button>
          </div>
        </div>

        <!-- Estado de Caja -->
        <div class="card-panel mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Estado de Caja</h3>
          
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
            <div class="badge-info">
              <p class="text-sm mb-1">Monto Inicial</p>
              <p class="text-xl font-bold" id="montoInicialMostrar">RD$ 0.00</p>
            </div>
            <div class="badge-gasto">
              <p class="text-sm mb-1">Total Gastos</p>
              <p class="text-xl font-bold" id="totalGastosMostrar">RD$ 0.00</p>
            </div>
            <div class="badge-monto">
              <p class="text-sm mb-1">Monto Final</p>
              <p class="text-xl font-bold" id="montoFinalMostrar">RD$ 0.00</p>
            </div>
          </div>
        </div>

        <!-- Lista de Gastos -->
        <h3 class="text-xl font-bold text-gray-800 mb-4">üí∏ Gastos del D√≠a</h3>
        <div id="listaGastos" class="space-y-3 mb-6"></div>
        <div id="noGastos" class="info-box text-center hidden">
          <p class="text-blue-700">üì≠ No hay gastos registrados</p>
        </div>

        <!-- Cerrar Caja -->
        <button onclick="cerrarCaja()" class="btn-danger w-full">
          üîí Cerrar Caja
        </button>
      </div>

      <!-- Historial -->
      <h3 class="text-2xl font-bold section-title mt-8 mb-4 text-center">üìã Historial de Cajas</h3>
      <div id="historialCajas" class="space-y-4"></div>
      <div id="noHistorial" class="info-box text-center hidden">
        <p class="text-blue-700">üì≠ No hay cajas registradas</p>
      </div>
    </div>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let cajaActual = null;
    let gastos = [];

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({
        text: mensaje,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function obtenerFechaHoyLocal() {
      const h = new Date();
      return `${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,'0')}-${String(h.getDate()).padStart(2,'0')}`;
    }

    async function abrirCaja() {
      const monto = parseFloat(document.getElementById('montoInicial').value);
      const fecha = document.getElementById('fechaCaja').value;
      
      if (!monto || monto <= 0) {
        return mostrarNotificacion('Ingrese monto inicial v√°lido', 'warning');
      }
      if (!fecha) {
        return mostrarNotificacion('Seleccione fecha', 'warning');
      }

      try {
        const { data, error } = await supabaseClient
          .from('caja_chica')
          .insert([{ 
            fecha, 
            monto_inicial: monto, 
            monto_gastos: 0, 
            monto_final: monto 
          }])
          .select()
          .single();

        if (error) throw error;
        
        cajaActual = data;
        gastos = [];
        
        // Ocultar loading y mostrar paneles
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('panelApertura').classList.add('hidden');
        document.getElementById('panelCajaAbierta').classList.remove('hidden');
        
        actualizarVistaCaja();
        await cargarHistorial();
        mostrarNotificacion('‚úÖ Caja abierta correctamente');
        
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    async function agregarGasto() {
      if (!cajaActual) {
        return mostrarNotificacion('Abra una caja primero', 'warning');
      }
      
      const descripcion = document.getElementById('descripcionGasto').value.trim();
      const monto = parseFloat(document.getElementById('montoGasto').value);

      if (!descripcion) {
        return mostrarNotificacion('Ingrese descripci√≥n del gasto', 'warning');
      }
      if (!monto || monto <= 0) {
        return mostrarNotificacion('Ingrese monto v√°lido', 'warning');
      }

      try {
        await supabaseClient
          .from('gastos')
          .insert([{ 
            caja_chica_id: cajaActual.id, 
            descripcion, 
            monto, 
            fecha: new Date().toISOString() 
          }]);

        const nuevoGasto = cajaActual.monto_gastos + monto;
        const nuevoFinal = cajaActual.monto_inicial - nuevoGasto;

        await supabaseClient
          .from('caja_chica')
          .update({ 
            monto_gastos: nuevoGasto, 
            monto_final: nuevoFinal 
          })
          .eq('id', cajaActual.id);

        cajaActual.monto_gastos = nuevoGasto;
        cajaActual.monto_final = nuevoFinal;

        document.getElementById('descripcionGasto').value = '';
        document.getElementById('montoGasto').value = '';
        
        await cargarGastos();
        actualizarVistaCaja();
        mostrarNotificacion('‚úÖ Gasto registrado');
        
      } catch (e) {
        mostrarNotificacion('Error: ' + e.message, 'error');
      }
    }

    async function cargarGastos() {
      if (!cajaActual) return;

      const { data } = await supabaseClient
        .from('gastos')
        .select('*')
        .eq('caja_chica_id', cajaActual.id)
        .order('id', { ascending: false });

      gastos = data || [];
    }

    function actualizarVistaCaja() {
      if (cajaActual) {
        document.getElementById('montoInicialMostrar').textContent = `RD$${parseFloat(cajaActual.monto_inicial).toFixed(2)}`;
        document.getElementById('totalGastosMostrar').textContent = `RD$${parseFloat(cajaActual.monto_gastos).toFixed(2)}`;
        document.getElementById('montoFinalMostrar').textContent = `RD$${parseFloat(cajaActual.monto_final).toFixed(2)}`;

        const lista = document.getElementById('listaGastos');
        const noGastos = document.getElementById('noGastos');
        lista.innerHTML = '';

        if (gastos.length === 0) {
          noGastos.classList.remove('hidden');
        } else {
          noGastos.classList.add('hidden');
          
          gastos.forEach(g => {
            const card = document.createElement('div');
            card.className = 'card-gasto';
            card.innerHTML = `
              <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">${g.descripcion}</h4>
                  <p class="text-sm text-gray-500">${new Date(g.fecha).toLocaleString()}</p>
                </div>
                <div class="badge-gasto">
                  RD$${parseFloat(g.monto).toFixed(2)}
                </div>
              </div>
            `;
            lista.appendChild(card);
          });
        }
      }
    }

    async function cerrarCaja() {
      if (!cajaActual) {
        return mostrarNotificacion('No hay caja abierta', 'warning');
      }
      
      if (confirm('¬øEst√°s seguro de que deseas cerrar la caja?')) {
        cajaActual = null;
        gastos = [];
        
        document.getElementById('panelCajaAbierta').classList.add('hidden');
        document.getElementById('panelApertura').classList.remove('hidden');
        
        actualizarVistaCaja();
        await cargarHistorial();
        mostrarNotificacion('üîí Caja cerrada');
      }
    }

    async function cargarHistorial() {
      const { data } = await supabaseClient
        .from('caja_chica')
        .select('*')
        .order('fecha', { ascending: false });

      const lista = document.getElementById('historialCajas');
      const noHistorial = document.getElementById('noHistorial');
      lista.innerHTML = '';

      if (!data || data.length === 0) {
        noHistorial.classList.remove('hidden');
        return;
      }
      
      noHistorial.classList.add('hidden');

      data.forEach(caja => {
        const card = document.createElement('div');
        card.className = 'card-historial';
        card.innerHTML = `
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div class="badge-info">
              üìÖ ${caja.fecha}
            </div>
            <div class="flex flex-wrap gap-3">
              <div class="badge-info">
                Inicial: RD$${parseFloat(caja.monto_inicial).toFixed(2)}
              </div>
              <div class="badge-gasto text-base">
                Gastos: RD$${parseFloat(caja.monto_gastos).toFixed(2)}
              </div>
              <div class="badge-monto text-base">
                Final: RD$${parseFloat(caja.monto_final).toFixed(2)}
              </div>
            </div>
          </div>
        `;
        lista.appendChild(card);
      });
    }

    async function imprimirCajaChica() {
      const { data: cajas } = await supabaseClient
        .from('caja_chica')
        .select('*, gastos(*)')
        .order('fecha', { ascending: false })
        .limit(30);

      if (!cajas || cajas.length === 0) {
        return mostrarNotificacion('No hay registros para imprimir', 'warning');
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      try {
        doc.addImage('LOGO LA PARADA DEL MAIZ.png', 'PNG', 10, 10, 30, 30);
      } catch(e) {}

      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.setTextColor(245, 158, 11);
      doc.text("Caja Chica - La Parada del Maiz", 105, 20, { align: "center" });
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text("Historial de Caja Chica", 105, 30, { align: "center" });
      doc.line(10, 35, 200, 35);

      let y = 45;
      let totalInicial = 0, totalGastos = 0, totalFinal = 0;

      cajas.forEach(caja => {
        doc.setFont("helvetica", "bold");
        doc.text(`Fecha: ${caja.fecha}`, 10, y);
        y += 6;
        
        doc.setFont("helvetica", "normal");
        doc.text(`Inicial: RD$${parseFloat(caja.monto_inicial).toFixed(2)} | Gastos: RD$${parseFloat(caja.monto_gastos).toFixed(2)} | Final: RD$${parseFloat(caja.monto_final).toFixed(2)}`, 10, y);
        y += 10;

        totalInicial += caja.monto_inicial;
        totalGastos += caja.monto_gastos;
        totalFinal += caja.monto_final;

        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      y += 5;
      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.setTextColor(245, 158, 11);
      doc.text(`Total Inicial: RD$${totalInicial.toFixed(2)}`, 105, y, { align: "center" });
      y += 8;
      doc.text(`Total Gastos: RD$${totalGastos.toFixed(2)}`, 105, y, { align: "center" });
      y += 8;
      doc.text(`Total Final: RD$${totalFinal.toFixed(2)}`, 105, y, { align: "center" });

      doc.save("Caja_Chica_Historial.pdf");
      mostrarNotificacion('‚úÖ PDF generado correctamente');
    }

    async function iniciar() {
      document.getElementById('fechaCaja').value = obtenerFechaHoyLocal();
      
      const hoy = obtenerFechaHoyLocal();
      const { data } = await supabaseClient
        .from('caja_chica')
        .select('*')
        .eq('fecha', hoy)
        .single();

      if (data) {
        cajaActual = data;
        await cargarGastos();
      }
      
      // Ocultar loading
      document.getElementById('loading').classList.add('hidden');
      
      if (cajaActual) {
        document.getElementById('panelApertura').classList.add('hidden');
        document.getElementById('panelCajaAbierta').classList.remove('hidden');
      } else {
        document.getElementById('panelApertura').classList.remove('hidden');
        document.getElementById('panelCajaAbierta').classList.add('hidden');
      }
      
      actualizarVistaCaja();
      await cargarHistorial();
    }

    // Actualizar conexi√≥n cada 30 segundos
    setInterval(async () => {
      const usuario = localStorage.getItem('usuario');
      if (usuario) {
        const usuarioObj = JSON.parse(usuario);
        try {
          await supabaseClient
            .from('usuarios')
            .update({ ultima_conexion: new Date().toISOString() })
            .eq('username', usuarioObj.username);
        } catch (e) {
          console.error('Error actualizando conexi√≥n:', e);
        }
      }
    }, 30000);

    window.onload = iniciar;
  </script>
</body>
</html>
