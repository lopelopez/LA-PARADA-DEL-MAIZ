<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caja Chica - La Parada del Maíz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>@media (max-width: 640px) { .nav-btn { font-size: 0.75rem; padding: 0.5rem 0.75rem; } }</style>
</head>
<body class="bg-yellow-50 font-sans min-h-screen">

  <div class="relative w-full h-28 sm:h-36 md:h-48 lg:h-56">
    <img src="LOGO LA PARADA DEL MAIZ.png" alt="Logo" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-yellow-500 bg-opacity-50 flex items-center justify-center px-2">
      <h1 class="text-white text-lg sm:text-xl md:text-3xl lg:text-4xl font-bold text-center drop-shadow-lg">La Parada del Maíz y El Majarete de Leidy</h1>
    </div>
  </div>

  <nav class="flex flex-wrap justify-center gap-2 sm:gap-3 mt-4 px-2">
    <a href="index.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded shadow text-sm sm:text-base">Artículos</a>
    <a href="facturacion.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded shadow text-sm sm:text-base">Facturación</a>
    <a href="historial.html" class="nav-btn bg-yellow-400 hover:bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded shadow text-sm sm:text-base">Historial</a>
  </nav>

  <!-- Registrar Gasto -->
  <section class="max-w-4xl mx-auto mt-6 sm:mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-md mx-2 sm:mx-4">
    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">Registrar Gasto (Caja Chica)</h2>
    
    <div class="flex flex-col gap-3 sm:gap-4 mb-4">
      <input type="text" id="descripcion" placeholder="Descripción del gasto" class="border border-gray-300 p-2 rounded-lg w-full text-sm sm:text-base">
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
        <input type="number" id="monto" placeholder="Monto (RD$)" min="0" step="0.01" class="border border-gray-300 p-2 rounded-lg w-full sm:w-1/2 text-sm sm:text-base">
        <div class="w-full sm:w-1/2">
          <label class="block mb-1 font-medium text-gray-700 text-sm">Fecha:</label>
          <input type="date" id="fechaGasto" class="border border-gray-300 p-2 rounded-lg w-full text-sm sm:text-base">
        </div>
      </div>
    </div>

    <button onclick="registrarGasto()" class="w-full sm:w-auto bg-red-400 hover:bg-red-500 text-white px-6 py-2 rounded-lg shadow text-sm sm:text-base">Registrar Gasto</button>
    <div id="loading" class="hidden mt-2 text-red-600 text-sm">Guardando...</div>
  </section>

  <!-- Lista de Gastos -->
  <section class="max-w-4xl mx-auto mt-6 sm:mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-md mx-2 sm:mx-4">
    <h3 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">Gastos del Día</h3>
    <ul id="listaGastos" class="space-y-2"></ul>
    <div class="mt-4 pt-4 border-t border-gray-200">
      <p class="text-lg font-semibold text-red-600">Total Gastos: RD$ <span id="totalGastos">0.00</span></p>
    </div>
  </section>

  <script>
    const supabaseUrl = "https://vurddrbkwuafszrddgxe.supabase.co";
    const supabaseKey = "sb_publishable_5bselDNif0wV61df7eZhgQ_E7gRM_zb";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    function mostrarNotificacion(mensaje, tipo = 'success') {
      Toastify({ text: mensaje, duration: 3000, gravity: "top", position: "right",
        backgroundColor: tipo === 'error' ? "#dc3545" : "#28a745"
      }).showToast();
    }

    function obtenerFechaHoyLocal() {
      const hoy = new Date();
      return `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
    }

    async function registrarGasto() {
      const descripcion = document.getElementById('descripcion').value.trim();
      const monto = parseFloat(document.getElementById('monto').value);
      const fecha = document.getElementById('fechaGasto').value;

      if (!descripcion || !monto || monto <= 0) {
        return mostrarNotificacion("Ingrese descripción y monto válido.", 'error');
      }
      if (!fecha) {
        return mostrarNotificacion("Seleccione una fecha.", 'error');
      }

      const loading = document.getElementById('loading');
      loading.classList.remove('hidden');

      try {
        await supabaseClient.from('gastos').insert([{ descripcion, monto, fecha: fecha + 'T12:00:00' }]);
        mostrarNotificacion("Gasto registrado correctamente.");
        document.getElementById('descripcion').value = "";
        document.getElementById('monto').value = "";
        cargarGastos();
      } catch (error) {
        mostrarNotificacion("Error: " + error.message, 'error');
      } finally {
        loading.classList.add('hidden');
      }
    }

    async function cargarGastos() {
      const hoy = obtenerFechaHoyLocal();
      try {
        const { data } = await supabaseClient.from('gastos').select('*').gte('fecha', hoy + 'T00:00:00').lte('fecha', hoy + 'T23:59:59').order('id', { ascending: false });
        
        const lista = document.getElementById('listaGastos');
        lista.innerHTML = "";
        let total = 0;

        if (data && data.length > 0) {
          data.forEach(gasto => {
            total += parseFloat(gasto.monto);
            const li = document.createElement('li');
            li.className = "bg-red-50 p-3 rounded-lg shadow flex justify-between items-center";
            li.innerHTML = `<span class="text-sm sm:text-base">${gasto.descripcion} - RD$${parseFloat(gasto.monto).toFixed(2)}</span>
              <span class="text-gray-500 text-xs sm:text-sm">${gasto.fecha.split('T')[0]}</span>`;
            lista.appendChild(li);
          });
        }
        document.getElementById('totalGastos').textContent = total.toFixed(2);
      } catch (error) {
        console.error(error);
      }
    }

    window.onload = () => {
      document.getElementById('fechaGasto').value = obtenerFechaHoyLocal();
      cargarGastos();
    };
  </script>
</body>
</html>